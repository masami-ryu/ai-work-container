# プラン作成コマンド・エージェント精度向上プラン

作成日: 2025年12月10日
作成者: Plan Creator エージェント
ステータス: Draft
更新履歴: 2025-12-10 レビュー指摘反映（REQ-001/REQ-004のトレーサビリティ追加、設定変更テスト追加）

## 1. 概要

### 目的
既存のプラン作成コマンド（`.claude/commands/plan.md`）およびエージェント（`.claude/agents/plan-creator.md`）を分析し、精度と効率を向上させるための改善を実施する。

### スコープ
- 対象: `.claude/commands/plan.md`, `.claude/agents/plan-creator.md`
- 対象外: 他のコマンド・エージェント、テンプレート（既に整備済み）

### 前提条件
- Claude Code CLI環境が構築済み
- 既存の改善プラン（251202, 251203）の知見を活用
- 既存プランの品質は高いが、コマンド・エージェント定義に改善余地あり

## 2. 現状分析

### 2.1 `.claude/commands/plan.md` の評価

| 評価項目 | 現状 | 評価 | 備考 |
|---------|------|------|-----|
| 基本構造 | 5ステップのワークフロー | ⭐⭐⭐⭐☆ | シンプルで明確 |
| allowed-tools | 設定あり（Read, Grep, Glob, Write, mcp__context7, mcp__msdocs, mcp__serena） | ⭐⭐⭐⭐⭐ | 適切なツール制限 |
| model | opus指定 | ⭐⭐⭐⭐⭐ | 高品質モデル使用 |
| コンテキスト参照 | @CLAUDE.md, @テンプレート, @既存プラン | ⭐⭐⭐⭐⭐ | 適切 |
| argument-hint | 未設定 | ⭐⭐⭐☆☆ | 改善可能 |
| タスク指示 | 5ステップ | ⭐⭐⭐⭐☆ | 簡潔だが詳細度不足 |

**現在の良い点:**
- ツール制限が適切に設定されている
- テンプレートと既存プランへの参照がある
- MCP活用が指示されている

**改善点:**
- ユーザー向けのヒント（argument-hint）がない
- ワークフロー選択の指示がない
- 品質検証ステップの明示がない

### 2.2 `.claude/agents/plan-creator.md` の評価

| 評価項目 | 現状 | 評価 | 備考 |
|---------|------|------|-----|
| 専門領域定義 | タスク分析・設計・プラン策定 | ⭐⭐⭐⭐⭐ | 明確 |
| ワークフロー選択 | Express/Standard/Comprehensive | ⭐⭐⭐⭐⭐ | 優秀 |
| 品質チェックリスト | 5項目 | ⭐⭐⭐⭐⭐ | 網羅的 |
| MCP活用ガイド | msdocs/context7 | ⭐⭐⭐⭐⭐ | 実用的 |
| 情報収集完了基準 | 表形式で明確 | ⭐⭐⭐⭐⭐ | 優秀 |
| ツール設定 | Read, Grep, Glob, Bash, WebFetch, mcp | ⭐⭐⭐⭐☆ | Bashは不要かも |
| model | opus | ⭐⭐⭐⭐⭐ | 適切 |
| 出力形式 | テンプレート参照 | ⭐⭐⭐⭐⭐ | 適切 |
| 制限事項 | ソースコード編集禁止 | ⭐⭐⭐⭐⭐ | 安全 |

**現在の良い点:**
- 3段階のワークフロー選択（Express/Standard/Comprehensive）
- 品質チェックリストが充実
- MCP活用ガイドが実用的
- 情報収集完了の判断基準が明確

**改善点:**
- プラン修正プロセスの具体化
- 実際のプラン出力例の追加
- 自己検証の実行タイミングの明確化

### 2.3 既存改善プランとの関係

| プラン | ステータス | 本プランとの関係 |
|-------|----------|----------------|
| 251202_プラン作成エージェント改善プラン.md | 一部完了 | GitHub Copilot向け、一部適用可能 |
| 251202_プラン作成エージェントパフォーマンス向上プラン.md | 一部完了 | 並列化・ワークフロー選択は既に反映済み |
| 251203_claude-code-settings-improvement.md | 一部完了 | 設定改善は別途対応済み |

### 2.4 実際の出力品質評価

サンプルプラン分析結果:
- `251207_devcontainer_worktree_permission_fix_v3.md`: ⭐⭐⭐⭐⭐ (非常に高品質)
- `251126_serena導入プラン.md`: ⭐⭐⭐⭐⭐ (非常に高品質)

**結論: 実際の出力品質は既に高い。コマンド・エージェント定義の微調整で更なる向上が可能。**

## 3. 要件と制約

| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | コマンドにargument-hintを追加 | 中 |
| REQ-002 | 要件 | コマンドにワークフロー選択の指示を追加 | 中 |
| REQ-003 | 要件 | エージェントの自己検証実行を明確化 | 中 |
| REQ-004 | 要件 | プラン出力例の追加 | 低 |
| CON-001 | 制約 | 既存の高品質な出力を維持 | - |
| CON-002 | 制約 | 過度な複雑化を避ける | - |
| GUD-001 | ガイドライン | ベストプラクティスに準拠 | - |

## 4. 実装ステップ

### Phase 1: コマンド改善（`.claude/commands/plan.md`）
**目標**: ユーザービリティと指示の明確化

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-001 | argument-hintを追加してユーザー入力のヒントを提供 | `.claude/commands/plan.md` | argument-hintがYAMLフロントマターに追加されている | [ ] |
| TASK-002 | description にワークフロー選択のヒントを追加 | `.claude/commands/plan.md` | descriptionが更新されている | [ ] |
| TASK-003 | タスクセクションにワークフロー選択ステップを追加 | 同上 | ワークフロー選択の指示が含まれている | [ ] |
| TASK-004 | 品質検証ステップを明示 | 同上 | 出力前検証の指示が含まれている | [ ] |

**改善後の `.claude/commands/plan.md`:**

```markdown
---
name: plan
description: 実行可能なプランを作成する（タスク規模に応じてExpress/Standard/Comprehensiveワークフローを選択）
allowed-tools: Read, Grep, Glob, Write, mcp__context7, mcp__msdocs, mcp__serena
model: opus
argument-hint: タスクの概要または目的を入力してください（例: 「認証機能の追加」「パフォーマンス最適化」）
---

## コンテキスト
- プロジェクト: @CLAUDE.md
- テンプレート: @ai/templates/plan-template.md
- 既存プラン: @ai/plans/
- エージェント定義: @.claude/agents/plan-creator.md

## タスク
以下のステップでプランを作成してください:

1. **ワークフロー選択**: タスク規模を評価し、適切なワークフローを選択
   - Express: 2ファイル以下の変更、影響範囲が限定的
   - Standard: 3-10ファイルに影響、中程度の複雑さ
   - Comprehensive: アーキテクチャ変更、多数ファイルに影響

2. **目的の明確化**: ユーザーの要求を確認し、達成すべき目標を定義

3. **情報収集**: 必要に応じてコードベース、ドキュメント、外部リソースを調査
   - 対象ファイルの特定（Glob/Grep）
   - 既存パターンの把握
   - 依存関係の理解

4. **MCPツール活用**: 最新情報が必要な場合はMCPツールを使用
   - msdocs: Microsoft/Azure公式ドキュメント
   - context7: コード例・スニペット
   - serena: セマンティックコード分析

5. **プラン策定**: 具体的なステップに分解し、実行可能なプランを作成

6. **品質検証**: 出力前に以下を確認
   - 完全性: すべての要件が反映されているか
   - アクション可能性: 具体的なアクション動詞で始まっているか
   - 測定可能性: 完了条件は客観的に判断可能か

7. **保存**: `ai/plans/YYMMDD_[タスク概要].md` に保存

## 出力形式
- テンプレート: @ai/templates/plan-template.md に準拠
- 日本語で記述
- 具体的なタスクとチェックリストを含める
```

### Phase 2: エージェント微調整（`.claude/agents/plan-creator.md`）
**目標**: 自己検証の明確化と効率化

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-005 | 自己検証の実行タイミングを明確化 | `.claude/agents/plan-creator.md` | 検証タイミングが明記されている | [ ] |
| TASK-006 | Bashツールを除外（情報収集には不要） | 同上 | toolsからBashが削除されている | [ ] |
| TASK-007 | プラン修正プロセスの具体化 | 同上 | 修正時のステップが具体化されている | [ ] |
| TASK-008 | プラン出力例を追加（簡潔なサンプル） | 同上 | 出力例セクションが追加されている | [ ] |

**改善内容:**

1. **tools設定の最適化:**
```yaml
tools: Read, Grep, Glob, WebFetch, mcp__context7, mcp__msdocs
```
- Bashを除外（プラン作成には不要、セキュリティリスク軽減）

2. **自己検証セクションの強化:**
```markdown
## 自己検証プロセス

### 検証タイミング
- Expressワークフロー: プラン作成直後に1回
- Standardワークフロー: 設計検討後とプラン作成後の2回
- Comprehensiveワークフロー: 各フェーズ完了時に検証

### 品質チェックリスト（必須）
プラン出力前に以下の項目を確認:

1. **完全性**: すべての要件がプランに反映されているか
2. **アクション可能性**: 各タスクは具体的なアクション動詞で始まるか
3. **測定可能性**: 完了条件は客観的に判断可能か
4. **依存関係**: タスク間の依存が正しく反映されているか
5. **リスク対応**: 主要なリスクへの対策が含まれているか

### 検証結果の対応
- すべてチェック通過 → プラン出力
- 1-2項目の問題 → 該当部分を修正して再検証
- 3項目以上の問題 → プラン全体を見直し
```

3. **プラン修正プロセスの具体化:**
```markdown
## プラン修正プロセス

1. **修正箇所の特定**
   - レビュー結果や追加情報から修正が必要な箇所を特定
   - 影響範囲を評価（局所的 vs 全体的）

2. **再調査**（必要な場合）
   - MCPツールで最新情報を再取得
   - 関連コードの再確認

3. **修正方針の決定**
   - 複数案がある場合は最も効果的な案を選択
   - トレードオフを明示

4. **修正の実施**
   - 局所的修正: 該当セクションのみ更新
   - 全体的修正: プラン全体を再構成

5. **再検証**
   - 品質チェックリストで検証
   - 変更履歴をプランに追記

6. **保存**
   - 同一ファイルを更新（ステータスを変更）
   - または新バージョンとして保存（v2, v3...）
```

4. **プラン出力例の追加:**
```markdown
## プラン出力例（Expressワークフロー）

以下は簡潔なプラン出力の例です:

### 例: README更新プラン
```
# README更新プラン

作成日: 2025年12月10日
作成者: Plan Creator エージェント
ステータス: Draft

## 1. 概要
### 目的
READMEに新機能のドキュメントを追加する。

### スコープ
- 対象: README.md
- 対象外: 他のドキュメントファイル

## 2. 要件と制約
| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | 新機能の使用方法を追加 | 高 |

## 3. 実装ステップ
| タスクID | 内容 | 完了条件 | 状態 |
|----------|------|---------|------|
| TASK-001 | 使用方法セクションを追加 | セクションが存在する | [ ] |

## 4. 成功基準
- [ ] 新機能の使用方法が記載されている
```
```

## 5. テスト計画

| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-001 | 機能 | `/plan` コマンドでExpressワークフローが選択されるか | 小規模タスクで5分以内にプラン生成 |
| TEST-002 | 機能 | `/plan` コマンドでComprehensiveワークフローが選択されるか | 大規模タスクで詳細なリスク分析を含むプラン生成 |
| TEST-003 | 品質 | 品質チェックリストが実行されているか | 出力プランが5項目すべてを満たす |
| TEST-004 | 回帰 | 既存の高品質なプラン出力が維持されているか | 改善前と同等以上の品質 |
| TEST-005 | 設定 | argument-hintがコマンド実行時に表示されるか | ユーザーにヒントが表示される |
| TEST-006 | 設定 | エージェントのtoolsからBashが除外されているか | Bashツールが利用不可 |

## 6. 成功基準

- [ ] コマンドにargument-hintが追加されている（REQ-001）
- [ ] コマンドにワークフロー選択の指示が追加されている（REQ-002）
- [ ] エージェントの自己検証タイミングが明確化されている（REQ-003）
- [ ] エージェントにプラン出力例が追加されている（REQ-004）
- [ ] エージェントからBashツールが除外されている
- [ ] コマンドに品質検証ステップが明示されている
- [ ] プラン修正プロセスが具体化されている
- [ ] テストシナリオで期待通りの動作を確認

## 7. リスクと対策

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| RISK-001 | 指示の複雑化によるパフォーマンス低下 | 中 | 低 | 簡潔さを維持、必要最小限の変更 |
| RISK-002 | ワークフロー選択の誤判断 | 低 | 中 | 具体的な数値基準（ファイル数）を明示 |
| RISK-003 | 既存の高品質出力の劣化 | 高 | 低 | 変更前にバックアップ、テストで確認 |

## 8. 依存関係

- Claude Code CLI環境
- 既存のテンプレート（`ai/templates/plan-template.md`）
- MCPサーバー（context7, msdocs, serena）

## 9. 次のアクション

1. [ ] 本プランのレビュー
2. [ ] Phase 1 の実装（コマンド改善: TASK-001〜004）
3. [ ] Phase 2 の実装（エージェント微調整: TASK-005〜008）
4. [ ] テストシナリオで検証（TEST-001〜006）
5. [ ] フィードバックに基づく調整

---

## 補足: 分析で判明した重要な発見

### 既に実装済みの優れた機能

1. **ワークフロー選択機能**: エージェントに既に Express/Standard/Comprehensive の3段階が定義済み
2. **品質チェックリスト**: 5項目の明確な基準が存在
3. **情報収集完了基準**: 表形式で明確に定義済み
4. **MCP活用ガイド**: 実用的な例が含まれている

### 本プランで追加する価値

1. **argument-hint追加（REQ-001）**: ユーザーがコマンド実行時に何を入力すべきか明確になる
2. **コマンド側へのワークフロー選択指示（REQ-002）**: エージェントには定義があるが、コマンドからの明示的な指示がなかった
3. **品質検証の実行タイミング明確化（REQ-003）**: チェックリストはあるが、いつ実行するかが曖昧だった
4. **プラン出力例追加（REQ-004）**: 具体的な出力イメージを提供
5. **Bashツールの除外**: セキュリティリスク軽減と役割の明確化
6. **プラン修正プロセスの具体化**: 「修正プロセス」の記載はあるが詳細度が不足していた

### 改善の方向性

- **大幅な変更は不要**: 既存の実装は非常に良好
- **微調整で精度向上**: 指示の明確化と一貫性の向上に注力
- **過度な複雑化を回避**: 簡潔さを維持しつつ必要な改善のみ実施

---
*このプランは Plan Creator エージェントによって作成されました*
