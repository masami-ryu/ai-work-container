# プルリクエストレビューエージェント改善プラン

作成日: 2025年12月2日  
更新日: 2025年12月2日  
作成者: Plan Creator エージェント  
ステータス: Completed

## 1. 概要

### 目的
Pull Request レビューエージェントが最大のパフォーマンスを発揮できるよう、エージェント定義を構造化・詳細化し、効率的かつ一貫性のあるレビューを実現する。

### スコープ
- 対象: `.github/agents/pull-request-reviewer.agent.md`
- 対象外: 他のエージェント定義ファイル、実際のPRレビュー実行

### 前提条件
- VS Code Chat Agent として動作
- GitHub MCP Server が利用可能
- Serena MCP が利用可能

## 2. 現状分析

### 現在のエージェント構成の課題

| ID | 課題 | 影響度 | 説明 |
|----|------|--------|------|
| ISS-001 | メタデータ不足 | 高 | `name`, `argument-hint`, `target`, `handoffs` が未定義 |
| ISS-002 | ツール定義の整理不足 | 中 | ツールがフラットに並べられ、用途別に分類されていない |
| ISS-003 | レビュープロセスの詳細不足 | 高 | 手順は記載されているが、具体的な評価観点やチェックリストがない |
| ISS-004 | ワークフロー選択機構がない | 中 | PRの規模に関係なく同じプロセスを適用 |
| ISS-005 | Tool Usage Policy がない | 中 | ツール使用の指針が不明確 |
| ISS-006 | 自己検証プロセスがない | 中 | レビュー品質の自己チェック機構が未実装 |
| ISS-007 | 並列実行パターンの指針がない | 低 | 効率的な情報収集の方針が未定義 |

## 3. 要件と制約

| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | レビューの観点を明確に定義する | 高 |
| REQ-002 | 要件 | PRの規模に応じたワークフローを選択できる | 高 |
| REQ-003 | 要件 | ツール使用ポリシーを明確化する | 高 |
| REQ-004 | 要件 | 自己検証プロセスを追加する | 中 |
| REQ-005 | 要件 | 構造化されたレビュー出力フォーマットを定義する | 中 |
| REQ-006 | 要件 | ハンドオフ機能を追加する | 低 |
| CON-001 | 制約 | 既存のGitHub MCPツールを活用する | - |
| CON-002 | 制約 | 日本語で応答する | - |
| GUD-001 | ガイドライン | Plan Creator エージェントの構造を参考にする | - |

## 4. 実装ステップ

### Phase 1: メタデータとツール定義の整理
**目標**: エージェントの基本構造を強化し、ツールを用途別に整理

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-001 | フロントマターに`name`, `argument-hint`, `target`を追加 | `pull-request-reviewer.agent.md` | メタデータが正しく設定されている | [ ] |
| TASK-002 | ツールを用途別（情報取得系、レビュー書き込み系、コード分析系）に分類 | `pull-request-reviewer.agent.md` | ツールがカテゴリ別にコメント付きで整理されている | [ ] |
| TASK-003 | 不要なツール（`runNotebooks`, `openSimpleBrowser`等）を削除 | `pull-request-reviewer.agent.md` | レビューに必要なツールのみが残っている | [ ] |
| TASK-004 | `handoffs`セクションを追加（修正依頼、実装確認用） | `pull-request-reviewer.agent.md` | 適切なハンドオフ先が定義されている | [ ] |

**Phase 1 出口条件**:
- [ ] エージェントファイルの YAML フロントマターが構文エラーなくパースできる
- [ ] VS Code でエージェントを呼び出し、ツール一覧が正しく表示される

### Phase 2: レビュープロセスの詳細化
**目標**: 具体的なレビュー観点とチェックリストを追加

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-005 | レビュー観点セクションを追加（コード品質、セキュリティ、パフォーマンス等） | `pull-request-reviewer.agent.md` | 5つ以上のレビュー観点が定義されている | [ ] |
| TASK-006 | PRタイプ別のレビューフォーカスを定義（機能追加、バグ修正、リファクタリング等） | `pull-request-reviewer.agent.md` | 3つ以上のPRタイプが定義されている | [ ] |
| TASK-007 | レビューコメントの書き方ガイドラインを追加 | `pull-request-reviewer.agent.md` | 建設的なコメントの例が含まれている | [ ] |

**Phase 2 出口条件**:
- [ ] エージェント定義内にレビュー観点が明記されている
- [ ] 擬似PRを用いてエージェントがレビュー観点に沿った指摘を出力することを確認

### Phase 3: ワークフロー選択機構の追加
**目標**: PRの規模・複雑さに応じた適切なワークフローを選択

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-008 | Quick Review（小規模PR向け）ワークフローを定義 | `pull-request-reviewer.agent.md` | 変更ファイル数5以下向けのプロセスが定義されている | [ ] |
| TASK-009 | Standard Review（中規模PR向け）ワークフローを定義 | `pull-request-reviewer.agent.md` | 変更ファイル数6-20向けのプロセスが定義されている | [ ] |
| TASK-010 | Deep Review（大規模・アーキテクチャ変更向け）ワークフローを定義 | `pull-request-reviewer.agent.md` | 20ファイル以上/アーキテクチャ変更向けのプロセスが定義されている | [ ] |

**Phase 3 出口条件**:
- [ ] 3種類のワークフローがエージェント定義内に記載されている
- [ ] 小規模PR（5ファイル以下）で Quick Review が選択されることを確認
- [ ] 大規模PR（20ファイル以上）で Deep Review が選択されることを確認

### Phase 4: Tool Usage Policy と並列実行パターンの追加
**目標**: 効率的なツール使用の指針を明確化

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-011 | Tool Usage Policy セクションを追加 | `pull-request-reviewer.agent.md` | ツール使用の基本方針が記載されている | [ ] |
| TASK-012 | 並列実行パターンを定義（PR情報取得、変更ファイル取得の並列化等） | `pull-request-reviewer.agent.md` | 並列実行可能な操作が明記されている | [ ] |
| TASK-013 | 情報収集の優先順位を定義 | `pull-request-reviewer.agent.md` | 取得すべき情報の順序が明記されている | [ ] |

**Phase 4 出口条件**:
- [ ] Tool Usage Policy セクションがエージェント定義に追加されている
- [ ] 実際のPRレビューでツールが並列呼び出しされていることをログで確認

### Phase 5: 品質保証と自己検証プロセスの追加
**目標**: レビュー品質の一貫性を確保

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-014 | レビュー完了チェックリストを追加 | `pull-request-reviewer.agent.md` | 5項目以上のチェックリストが含まれている | [ ] |
| TASK-015 | レビュー出力フォーマットを定義 | `pull-request-reviewer.agent.md` | 構造化されたレビューレポートのテンプレートが含まれている | [ ] |
| TASK-016 | 自己検証プロセスを追加 | `pull-request-reviewer.agent.md` | レビュー提出前の確認項目が定義されている | [ ] |

**Phase 5 出口条件**:
- [ ] 自己検証チェックリストがエージェント定義に含まれている
- [ ] 実際のPRレビューでレビュー出力が定義フォーマットに準拠していることを確認

## 5. 改善後のエージェント構造案

```yaml
---
name: PullRequestReviewer
description: 'プルリクエストをレビューするエージェント - コード品質とベストプラクティスを評価'
argument-hint: 'PRのURLまたは番号を入力してください（例: "#123" または "PR #123をレビューして"）'
model: 'Claude Opus 4.5 (Preview)'
target: vscode
tools: [
  # 情報収集・検索系
  'search',
  'usages',
  'problems',
  'changes',
  'fetch',
  'githubRepo',
  'runSubagent',
  # タスク管理
  'todos',
  # MCP: ドキュメント参照
  'context7/*',
  'msdocs/*',
  # MCP: GitHub情報取得（読み取り系）
  'github-mcp-server/pull_request_read',
  'github-mcp-server/get_file_contents',
  'github-mcp-server/list_commits',
  'github-mcp-server/list_pull_requests',
  'github-mcp-server/issue_read',
  'github-mcp-server/search_code',
  # MCP: GitHub操作（書き込み系）
  'github-mcp-server/pull_request_review_write',
  'github-mcp-server/add_comment_to_pending_review',
  # MCP: コード分析
  'serena/*'
]
handoffs:
    - label: 修正を依頼
      agent: agent
      prompt: 'このPRの指摘事項を修正してください: {{selection}}'
      send: false
    - label: 実装を確認
      agent: ask
      prompt: 'この実装について確認してください: {{selection}}'
      send: false
---
```

## 6. レビュー観点の詳細案

### コード品質
- 命名規則の一貫性
- 関数/メソッドの単一責任原則
- コードの重複
- エラーハンドリング
- コメントの適切さ

### セキュリティ
- 入力値の検証
- 機密情報の扱い
- 認証・認可の実装
- SQLインジェクション/XSS対策

### パフォーマンス
- アルゴリズムの効率性
- 不要なループ/計算
- メモリ使用量
- N+1問題

### テスト
- テストカバレッジ
- エッジケースの網羅
- テストの可読性

### 設計
- 既存パターンとの一貫性
- 拡張性
- 依存関係の管理

## 7. テスト計画

### 7.1 単体テスト（各フェーズ完了時）

| テストID | 種別 | 内容 | 期待結果 | 対象フェーズ |
|----------|------|------|---------|-------------|
| TEST-001 | 構文検証 | エージェントファイルのYAMLパース | エラーなくパースできる | Phase 1 |
| TEST-002 | 起動確認 | VS Codeでエージェント呼び出し | エージェントが応答する | Phase 1 |
| TEST-003 | ツール確認 | 定義されたツールが利用可能 | 全ツールがツール一覧に表示される | Phase 1 |
| TEST-004 | 観点適用 | 擬似PRでレビュー実行 | 定義した観点に沿った指摘が出力される | Phase 2 |
| TEST-005 | ワークフロー選択 | 異なる規模のPRでレビュー実行 | 規模に応じたワークフローが選択される | Phase 3 |
| TEST-006 | 並列実行 | PR情報取得時のツール呼び出し確認 | 複数ツールが並列で呼び出される | Phase 4 |
| TEST-007 | 出力フォーマット | レビュー結果の形式確認 | 定義したフォーマットで出力される | Phase 5 |

### 7.2 統合テスト（全フェーズ完了後）

| テストID | シナリオ | 使用するPR | 確認項目 |
|----------|---------|-----------|---------|
| INT-001 | Quick Review | 変更ファイル3件の小規模PR | 5分以内にレビュー完了、基本的な指摘が出力される |
| INT-002 | Standard Review | 変更ファイル10件の中規模PR | 15分以内にレビュー完了、詳細な指摘とコード品質評価が出力される |
| INT-003 | Deep Review | 変更ファイル25件の大規模PR | 30分以内にレビュー完了、アーキテクチャ観点の指摘が含まれる |
| INT-004 | ハンドオフ | レビュー後の修正依頼 | 「修正を依頼」ハンドオフが正常に動作する |
| INT-005 | エラーケース | 存在しないPR番号を指定 | 適切なエラーメッセージが表示される |

### 7.3 テスト実施手順

1. **テスト用PRの準備**
   - リポジトリ内で小規模（3ファイル）、中規模（10ファイル）、大規模（25ファイル）の擬似PRを作成
   - または既存のクローズ済みPRを使用

2. **各フェーズ完了時のテスト**
   - 該当フェーズの単体テストを実施
   - 失敗した場合は修正後に再テスト

3. **統合テスト**
   - 全フェーズ完了後にINT-001〜INT-005を順次実施
   - 結果を `ai/reviews/` に記録

## 8. 成功基準

### 定量的指標
| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| Quick Review 完走率 | 100% | 小規模PR（5ファイル以下）を3件レビューし全ステップ完走 |
| Standard Review 完走率 | 100% | 中規模PR（6-20ファイル）を2件レビューし全ステップ完走 |
| Deep Review 完走率 | 100% | 大規模PR（20ファイル以上）を1件レビューし全ステップ完走 |
| エージェント起動成功率 | 100% | VS Code でエージェント呼び出しが10回連続成功 |

### 定性的確認項目
- [ ] メタデータが完全に定義されている（`name`, `argument-hint`, `target`, `handoffs`）
- [ ] ツールが用途別に分類され、不要なツールが削除されている
- [ ] 5つ以上のレビュー観点が具体的に定義されている
- [ ] 3つのワークフロー（Quick/Standard/Deep）が定義されている
- [ ] Tool Usage Policy が明記されている
- [ ] 自己検証チェックリストが含まれている
- [ ] レビュー出力フォーマットが定義されている

## 9. リスクと対策

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| RISK-001 | 詳細化しすぎてエージェントの柔軟性が低下 | 中 | 中 | ガイドラインは推奨として記載し、状況に応じた判断を許容する |
| RISK-002 | 追加したツールが動作しない | 低 | 低 | 実際のPRレビューで動作確認を行う |
| RISK-003 | レビュー時間が長くなる | 中 | 中 | ワークフロー選択により適切な深度でレビューを実施 |

## 10. 依存関係

- GitHub MCP Server の正常動作
- Serena MCP の正常動作
- VS Code Chat Agent 機能

## 11. 次のアクション

1. [ ] Phase 1（メタデータとツール定義の整理）を実装する
2. [ ] Phase 1 の出口条件を確認し、TEST-001〜003 を実施する
3. [ ] Phase 2-5 を順次実装し、各フェーズの出口条件を確認する
4. [ ] 統合テスト（INT-001〜005）を実施する
5. [ ] テスト結果を `ai/reviews/` に記録する

---
*このプランは Plan Creator エージェントによって作成されました*
