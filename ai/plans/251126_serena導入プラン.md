# Serena MCP 導入プラン

## 概要

devcontainer環境にSerena MCP (Model Context Protocol) サーバーを導入するために、uvパッケージマネージャーをインストールする実装プランです。

**対象ファイル**: `.devcontainer/post-create.sh`  
**目的**: `uvx`コマンドでSerena MCPサーバーを実行できるようにする  
**関連Issue**: `ai/issues/251126_serena導入.md`

## 背景

### Serena MCPとは
Serena MCPは、セマンティックコード解析を備えたコーディングエージェントツールキットです。MCP経由でAIアシスタントに以下の機能を提供します：

- セマンティックコード検索
- プロジェクト構造分析
- コードリファレンス解析
- 高度なコンテキスト理解

### uvとは
[uv](https://github.com/astral-sh/uv)は、Astral社が開発した高速なPythonパッケージマネージャーおよびプロジェクト管理ツールです。

**特徴**:
- Rustで実装された高速性能（pipの10-100倍高速）
- スタンドアロンインストーラーで依存関係なし
- `uvx`コマンドでPythonツールを一時的に実行可能
- 軽量で冪等性の高いインストール

### 現在の状況
`.vscode/mcp.json`にはSerenaサーバーの設定が既に存在しますが、`uvx`コマンドが利用できないため動作しません。

```json
"serena": {
  "command": "uvx",
  "args": [
    "--from",
    "git+https://github.com/oraios/serena",
    "serena",
    "start-mcp-server",
    "--context",
    "ide-assistant",
    "--project",
    "$(pwd)"
  ]
}
```

## 実装プラン

### Phase 1: uvインストール処理の追加

#### ステップ1.1: post-create.shへのuv インストールコード追加

**ファイル**: `.devcontainer/post-create.sh`  
**挿入位置**: Claude Code CLIインストールセクションの直後、Claude Code環境変数設定（`# Claude Code 環境変数(オプション)`コメント）の直前

**実装方針**: 

本プランでは**既存パターンとの一貫性を優先してインライン実装**を採用します。

**将来的な改善案**（オプション）:
- 類似ロジック（ログ管理、リトライ処理）を共通関数化し、スクリプト冒頭で定義
- 関数化する場合の例: `install_tool()`, `add_to_path()`, `log_with_rotation()`
- または「依存ツールインストール」セクションとして分離し、Claude Code/uvなどをまとめて管理

現時点では既存の Claude Code インストール処理と同じパターンで実装することで、
保守性と可読性のバランスを取ります。

**実装内容**:

```bash
# ======================================
# uv (Astral Python Package Manager) のインストール
# ======================================
echo "uv をインストール中..."

# インストール済みチェック（冪等性確保）
if command -v uv >/dev/null 2>&1; then
  INSTALLED_UV_VERSION=$(uv --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' || echo "unknown")
  echo "uv は既にインストールされています: v${INSTALLED_UV_VERSION}"
  echo "再インストールをスキップします。"
else
  # ログファイルの設定（日付ローテーション）
  UV_LOG_DIR="${HOME}/.cache/uv-install-logs"
  mkdir -p "$UV_LOG_DIR"
  UV_LOGFILE="${UV_LOG_DIR}/install-$(date '+%Y%m%d').log"
  touch "$UV_LOGFILE"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] uv インストール開始" | tee -a "$UV_LOGFILE"

  # 古いログファイルのクリーンアップ（7日以上前のログを削除）
  find "$UV_LOG_DIR" -name "install-*.log" -mtime +7 -delete 2>/dev/null || true

  # uvインストールスクリプトのダウンロードと実行
  UV_INSTALL_URL="https://astral.sh/uv/install.sh"
  UV_MAX_RETRIES=3
  UV_RETRY_COUNT=0

  while [ $UV_RETRY_COUNT -lt $UV_MAX_RETRIES ]; do
    if curl -fsSL "$UV_INSTALL_URL" 2>&1 | tee -a "$UV_LOGFILE" | sh; then
      echo "uv のインストールに成功しました。" | tee -a "$UV_LOGFILE"
      break
    else
      UV_RETRY_COUNT=$((UV_RETRY_COUNT + 1))
      if [ $UV_RETRY_COUNT -lt $UV_MAX_RETRIES ]; then
        echo "[警告] インストール失敗。リトライ中... ($UV_RETRY_COUNT/$UV_MAX_RETRIES)" | tee -a "$UV_LOGFILE"
        sleep 2
      else
        echo "[エラー] uv のインストールに失敗しました。ログを確認してください: $UV_LOGFILE" | tee -a "$UV_LOGFILE"
      fi
    fi
  done

  # インストール先の確認とPATH設定
  UV_INSTALL_DIR="$HOME/.local/bin"
  if [ ! -d "$UV_INSTALL_DIR" ]; then
    UV_INSTALL_DIR="$HOME/.cargo/bin"
  fi

  # PATH への追加（存在しない場合のみ）
  if [ -d "$UV_INSTALL_DIR" ]; then
    export PATH="$UV_INSTALL_DIR:$PATH"
    
    # 各シェル設定ファイルへの PATH 追加（bash / zsh 対応）
    for SHELL_RC in "$HOME/.bashrc" "$HOME/.zshrc"; do
      # シェル設定ファイルが存在しない場合は作成
      if [ ! -f "$SHELL_RC" ]; then
        touch "$SHELL_RC"
        echo "$(basename $SHELL_RC) を新規作成しました" | tee -a "$UV_LOGFILE"
      fi
      
      # マーカーコメントの有無に関わらず、ディレクトリパスの重複チェックを実施
      # これにより手動追加された設定との競合も回避
      if ! grep -qF "$UV_INSTALL_DIR" "$SHELL_RC"; then
        echo "" >> "$SHELL_RC"
        echo "# uv - Astral Python Package Manager" >> "$SHELL_RC"
        echo "# PATH重複回避のためcase文を使用" >> "$SHELL_RC"
        echo "case \":\$PATH:\" in" >> "$SHELL_RC"
        echo "  *:\"$UV_INSTALL_DIR\":*) ;;" >> "$SHELL_RC"
        echo "  *) export PATH=\"$UV_INSTALL_DIR:\$PATH\" ;;" >> "$SHELL_RC"
        echo "esac" >> "$SHELL_RC"
        echo "$(basename $SHELL_RC) に uv の PATH を追加しました" | tee -a "$UV_LOGFILE"
      else
        echo "$(basename $SHELL_RC) には既に $UV_INSTALL_DIR が含まれています（スキップ）" | tee -a "$UV_LOGFILE"
      fi
    done
  fi

  # インストール確認
  if command -v uv >/dev/null 2>&1; then
    FINAL_UV_VERSION=$(uv --version 2>/dev/null || echo "version check failed")
    echo "uv が正常にインストールされました: ${FINAL_UV_VERSION}" | tee -a "$UV_LOGFILE"
    
    # uvx の確認
    if command -v uvx >/dev/null 2>&1; then
      echo "uvx コマンドも利用可能です。" | tee -a "$UV_LOGFILE"
    else
      echo "[警告] uvx コマンドが見つかりません。" | tee -a "$UV_LOGFILE"
    fi
  else
    echo "[警告] uv が見つかりません。手動でインストールしてください。" | tee -a "$UV_LOGFILE"
  fi
fi

echo ""
```

#### ステップ1.2: 実装時の注意点

**冪等性の確保**:
- `command -v uv`でインストール済みチェックを実行
- 既にインストールされている場合は処理をスキップ
- コンテナ再ビルド時に無駄な処理を実行しない

**ログ管理**:
- 日付ローテーションによるログファイル管理
- 7日以上前のログは自動削除
- インストール成功/失敗の詳細を記録

**リトライ処理**:
- ネットワークエラーに対応するため最大3回リトライ
- リトライ間隔は2秒

**PATH設定**:
- インストール先は `~/.local/bin` を優先
- bash/zshの両方に対応
- シェル設定ファイル(`~/.bashrc`, `~/.zshrc`)が存在しない場合は自動作成
- ディレクトリパスの文字列検索で冪等性を確保（マーカーの有無に依存しない）
- `case ":$PATH:"` パターンで実行時のPATH重複を防止
- 手動追加された設定との競合も回避（`grep -qF`で完全一致チェック）

### Phase 2: 検証

#### ステップ2.1: コンテナ再ビルドと動作確認

**前提**: 以下の手順は devcontainer のデフォルトユーザー（通常は `vscode`）で実行することを想定しています。

**手順**:

1. **コンテナの再ビルド**:
   ```
   VS Code Command Palette > Dev Containers: Rebuild Container
   ```

2. **uvインストールの確認**:
   ```bash
   uv --version
   # 期待される出力: uv 0.x.x (または最新バージョン)
   
   # 注意: uvxは最新版でシンボリックリンクのため--versionが失敗する可能性あり
   # uv x --versionは存在しないため、command -v uvxまたはuvx --helpで確認
   command -v uvx && echo "uvx available" || echo "uvx not found"
   
   which uv
   # 期待される出力例: $HOME/.local/bin/uv または $HOME/.cargo/bin/uv
   # 実際のパス: /home/vscode/.local/bin/uv (vscodeuserの場合)
   ```

3. **PATHの確認**（厳密な検証）:
   ```bash
   # PATHをコロン区切りで分割して完全一致検証（環境変数を使用）
   echo $PATH | tr ':' '\n' | grep -Fx "$HOME/.local/bin"
   # または
   echo $PATH | tr ':' '\n' | grep -Fx "$HOME/.cargo/bin"
   
   # より簡易的な確認（部分一致でも可）
   echo $PATH | grep -E "(\.local/bin|\.cargo/bin)"
   ```

4. **シェル設定ファイルの確認**:
   ```bash
   # bash ユーザーの場合
   grep -A 6 "# uv - Astral Python Package Manager" ~/.bashrc
   # 期待される出力例（$HOME/.local/bin の場合）:
   # # uv - Astral Python Package Manager
   # # PATH重複回避のためcase文を使用
   # case ":$PATH:" in
   #   *:"$HOME/.local/bin":*) ;;
   #   *) export PATH="$HOME/.local/bin:$PATH" ;;
   # esac
   # 注意: 実際には絶対パス（例: /home/vscode/.local/bin）が記載されます
   
   # zsh ユーザーの場合（実装では両方に追記される）
   grep -A 6 "# uv - Astral Python Package Manager" ~/.zshrc
   # 同様のcase文ブロックが存在することを確認
   ```

5. **ログファイルの確認**:
   ```bash
   ls -lh ~/.cache/uv-install-logs/
   cat ~/.cache/uv-install-logs/install-$(date '+%Y%m%d').log
   ```

#### ステップ2.2: Serena MCP の動作確認

**手順**:

1. **MCP設定の確認**:
   ```bash
   cat .vscode/mcp.json | jq '.servers.serena'
   ```

2. **setup-claude-mcp.sh の実行**:
   ```bash
   bash /workspaces/ai-work-container/.devcontainer/setup-claude-mcp.sh
   ```

3. **Claude Code でSerenaサーバーの確認**:
   ```bash
   claude mcp list
   # 期待される出力: serena サーバーが一覧に含まれる
   ```

4. **MCPログの確認**（重要）:
   ```bash
   # Claude CodeのMCPログにエラーがないか確認
   ls -lh ~/.config/claude-code/logs/
   tail -n 50 ~/.config/claude-code/logs/mcp-*.log | grep -i "serena\|error\|failed"
   
   # setup-claude-mcp.shの実行ログを確認
   grep -i "serena" /tmp/mcp-setup*.log 2>/dev/null || echo "ログなし"
   ```

5. **Serenaプロセスの確認**（STDIO型MCPサーバーの検証）:
   ```bash
   # Serenaは要求時に起動するため、Claude Code使用中にプロセス確認
   # 注意: STDIOサーバーは常駐しないため、通常時はプロセスが見つからないのが正常
   ps aux | grep -i "serena\|uvx" | grep -v grep
   ```

6. **Serenaサーバーのテスト実行**（オプション）:
   ```bash
   # Serenaが正常にインストールできるか確認
   uvx --from git+https://github.com/oraios/serena serena --help
   ```

### Phase 3: トラブルシューティング

#### 問題3.1: uvインストールが失敗する

**症状**: `curl -fsSL https://astral.sh/uv/install.sh | sh` が失敗する

**解決方法**:

1. **ネットワーク接続の確認**:
   ```bash
   curl -I https://astral.sh/uv/install.sh
   ```

2. **wgetを使用した代替インストール** (Dockerfileでwgetインストール済み):
   ```bash
   wget -qO- https://astral.sh/uv/install.sh | sh
   ```

3. **手動インストール**:
   ```bash
   # GitHubリリースから直接ダウンロード
   curl -LsSf https://github.com/astral-sh/uv/releases/latest/download/uv-installer.sh | sh
   ```

4. **ログの確認**:
   ```bash
   cat ~/.cache/uv-install-logs/install-$(date '+%Y%m%d').log
   ```

#### 問題3.2: uvxコマンドが見つからない、または --version が失敗する

**症状**: `uv`はインストールされているが、`uvx`が実行できない、または `uvx --version` がエラーになる

**原因と対処**:

最新のuvでは`uvx`の実装方法が以下のように変遷しています：
- **uv 0.5.0以降**: `uvx`は`uv x`のシンボリックリンクまたはエイリアス
- **最新版**: `uvx`コマンド自体が`uv`バイナリへのシンボリックリンク（実行引数で動作を切り替え）
- **重要**: `uvx --version` は一部バージョンで非サポート。代わりに `uv --version` または `command -v uvx` で確認

**解決方法**:

1. **uvxの存在確認（--versionに依存しない方法）**:
   ```bash
   # uvxコマンドの存在確認
   command -v uvx && echo "uvx available" || echo "uvx not found"
   
   # uvのバージョン確認（uvxも同じバージョン）
   uv --version
   ```

2. **uvのバージョンと構成確認**:
   ```bash
   uv --version
   uv version  # より詳細な情報
   ```

3. **シンボリックリンクの確認**:
   ```bash
   # シンボリックリンクの確認（環境変数を使用）
   ls -la "$HOME/.local/bin/uvx" 2>/dev/null || ls -la "$HOME/.cargo/bin/uvx" 2>/dev/null
   
   # リンク先の確認
   readlink -f $(which uvx) 2>/dev/null || echo "uvx not found"
   ```

4. **代替コマンドの使用**:
   ```bash
   # uvxが見つからない場合は uv x サブコマンドを使用
   uv x --from git+https://github.com/oraios/serena serena --help
   ```

5. **uvの再インストールまたはアップデート**:
   ```bash
   # セルフアップデートを試行
   uv self update
   
   # または完全再インストール
   curl -fsSL https://astral.sh/uv/install.sh | sh
   ```

6. **手動でシンボリックリンク作成**（最終手段）:
   ```bash
   # uvxが存在しない場合、手動で作成（環境変数を使用）
   ln -sf "$HOME/.local/bin/uv" "$HOME/.local/bin/uvx"
   # または
   ln -sf "$HOME/.cargo/bin/uv" "$HOME/.cargo/bin/uvx"
   ```

#### 問題3.3: PATHが正しく設定されない

**症状**: `uv: command not found` エラーが発生する

**解決方法**:

1. **手動でPATHを設定**:
   ```bash
   export PATH="$HOME/.local/bin:$PATH"
   # または
   export PATH="$HOME/.cargo/bin:$PATH"
   ```

2. **シェル設定の再読み込み**:
   ```bash
   source ~/.bashrc
   ```

3. **インストール先の確認**:
   ```bash
   find ~ -name uv -type f 2>/dev/null
   ```

#### 問題3.4: Serenaサーバーが起動しない

**症状**: `claude mcp list`でserenaが表示されない、またはエラーが出る

**解決方法**:

1. **uvx単体でのテスト**:
   ```bash
   uvx --from git+https://github.com/oraios/serena serena --version
   ```

2. **Gitアクセスの確認**:
   ```bash
   git ls-remote https://github.com/oraios/serena
   ```

3. **Python環境の確認**:
   ```bash
   # Serenaのpyproject.tomlで「requires-python = ">=3.11, <3.12"」と明記されている
   uv python list
   uv python install 3.11  # Serenaが必要とするPythonバージョン(3.11必須)
   ```

4. **MCPログの確認**:
   ```bash
   # Claude Codeのログを確認
   cat ~/.config/claude-code/logs/*.log | grep -i serena
   ```

5. **手動でMCP設定を更新**:
   ```bash
   bash /workspaces/ai-work-container/.devcontainer/setup-claude-mcp.sh --force
   ```

## 実装チェックリスト

### Phase 1: 実装
- [ ] `.devcontainer/post-create.sh`にuvインストールコードを追加
- [ ] コード挿入位置の確認（Claude Code CLIセクションの直後）
- [ ] 冪等性チェックロジックの実装
- [ ] ログローテーション処理の実装
- [ ] リトライロジックの実装
- [ ] PATH設定処理の実装

### Phase 2: 検証
- [ ] コンテナを再ビルド
- [ ] `uv --version`で正常なバージョンが表示される
- [ ] `command -v uvx`でuvxコマンドの存在が確認できる（または`uvx --help`が実行できる）
- [ ] `which uv`で正しいパス（`$HOME/.local/bin`または`$HOME/.cargo/bin`）が表示される
- [ ] `echo $PATH`にuvのパスが含まれる
- [ ] `~/.bashrc`と`~/.zshrc`にuv PATHが重複なく追加されている（ファイルが自動作成されていることも確認）
- [ ] ログファイル`~/.cache/uv-install-logs/`が作成されている
- [ ] `bash setup-claude-mcp.sh`が正常に完了する
- [ ] `claude mcp list`でserenaサーバーが表示される
- [ ] MCPログ（`~/.config/claude-code/logs/`）にserena関連のエラーがない
- [ ] STDIOサーバーとしてのSerena動作を確認（プロセスは常駐しない）

### Phase 3: 統合テスト
- [ ] Claude Codeでserenaサーバーに接続できる
- [ ] Serenaのツールがエージェントから利用可能
- [ ] コンテナ再ビルド時にuvの再インストールがスキップされる（冪等性）
- [ ] 古いログファイルが自動削除される（7日経過後）

## 期待される成果

1. **uvとuvxの利用可能性**: コンテナ内で`uv`および`uvx`コマンドが使用可能になる
2. **Serena MCPの動作**: Claude Code経由でSerena MCPサーバーが利用可能になる
3. **冪等性の確保**: コンテナ再ビルド時に無駄なインストール処理が実行されない
4. **ログ管理**: インストール履歴が適切に記録され、古いログは自動削除される
5. **エラーハンドリング**: ネットワークエラー等に対するリトライ処理が機能する

## 依存関係

### 必要な既存コンポーネント
- `.devcontainer/post-create.sh`（既存）
- `.vscode/mcp.json`（既存、Serena設定済み）
- `.devcontainer/setup-claude-mcp.sh`（既存、MCP自動設定スクリプト）
- Claude Code CLI（既存、post-create.shでインストール済み）

### 前提条件

#### システム要件
- インターネット接続（uvインストールスクリプトのダウンロードに必要）

#### 必須パッケージ（Dockerfileで確認済み）

以下のパッケージがDockerfileでインストールされていることを前提としています：

```dockerfile
# .devcontainer/Dockerfile で確認済み
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
    curl          # uvインストールスクリプトのダウンロードに必要 ✓
    wget          # curl失敗時の代替ダウンロードツール ✓
    git           # Serenaのgit+https://クローンに必要 ✓
    build-essential  # Python拡張ビルドに必要(Serena依存) ✓
    libssl-dev    # SSL/TLS通信に必要 ✓
    ca-certificates  # HTTPS通信の証明書検証に必要 ✓
```

**確認方法**:
```bash
# Dockerfileの依存関係を確認
grep -E "(curl|wget|git|build-essential|libssl-dev|ca-certificates)" .devcontainer/Dockerfile
```

#### Python環境(Serena実行時に必要)

Serenaは`git+https://github.com/oraios/serena`からソースを取得してビルドするため、以下が必要です:

**Python要件** ([pyproject.toml](https://github.com/oraios/serena/blob/main/pyproject.toml)から引用):
- **Python 3.11必須** (`requires-python = ">=3.11, <3.12"`)
- Python 3.12以降は非対応(uvが自動的に3.11をインストール)

**ビルドシステム** (pyproject.toml `[build-system]` より):
- ビルドバックエンド: `hatchling` (Pure Pythonビルドツール)
- C/C++コンパイラ: `build-essential` で提供（Pythonパッケージの一部がC拡張を含む可能性あり）
- Python開発ヘッダー: uvが必要に応じて管理

**重要**: 
- uvは必要なPythonバージョン(3.11)とビルドツール(hatchling)を自動管理
- Serenaはwheelを配布していないため、git経由のインストール時にソースからビルド
- Dockerfileの `build-essential`, `libssl-dev` はビルド時の依存関係として必須

#### 不足時の対処

Dockerfileに上記パッケージが含まれていない場合は、以下を追加してください：

```dockerfile
# 不足パッケージの追加例
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
    build-essential \
    libssl-dev \
    ca-certificates \
  && rm -rf /var/lib/apt/lists/*
```

## 参考資料

- [uv公式ドキュメント - Installation](https://docs.astral.sh/uv/getting-started/installation/)
- [Serena GitHub Repository](https://github.com/oraios/serena)
- [Zed MCP Server Serena](https://github.com/delano/zed-mcp-server-serena)
- [既存プラン: 251124_claudecode導入プラン_v2.md](./251124_claudecode導入プラン_v2.md)

## 備考

### なぜDockerfileではなくpost-create.shなのか

**post-create.shを選択した理由**:
1. **既存パターンとの一貫性**: Claude Code CLIも同様にpost-create.shでインストールされている
2. **柔軟性**: ユーザー権限で実行でき、ホームディレクトリへのインストールが容易
3. **冪等性の実装が容易**: スクリプト内で簡単に条件分岐できる
4. **ログ管理**: ユーザー領域にログを保存しやすい
5. **再ビルド不要**: post-create.shの修正のみでコンテナ再起動で反映可能

**Dockerfileでの実装が不適切な理由**:
- イメージビルド時にインストールすると、バージョン更新時に再ビルドが必要
- ユーザーホームディレクトリへのインストールが困難
- ログ管理が複雑化する

### uvのインストール先について

uvは以下の優先順位でインストール先を決定します：

1. `~/.local/bin/` （uv 0.5.0以降のデフォルト）
2. `~/.cargo/bin/` （uv 0.5.0未満のレガシーパス）

本プランでは両方に対応し、存在するパスを自動検出してPATHに追加します。
