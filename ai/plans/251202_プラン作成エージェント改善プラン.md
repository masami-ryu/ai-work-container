# プラン作成エージェント改善プラン

作成日: 2025年12月2日  
更新日: 2025年12月2日（レビュー結果反映）

## 目的

GitHub Copilot Chat のカスタムエージェント機能を活用し、プラン作成エージェント (`plan-creater.agent.md`) のパフォーマンスを最大化する。

## 前提条件

- **ターゲット環境**: VS Code のみ（`target: vscode`）
- **ツール方針**: 基本は読み取り専用だが、Markdownファイルの作成・編集に必要なツールは残す
- **プラン出力**: `ai/plans/` ディレクトリにMarkdownファイルとして保存

## 調査結果のサマリー

### カスタムエージェントのベストプラクティス（公式ドキュメントより）

#### 1. ファイル構造
- **拡張子**: `.agent.md`（以前の `.chatmode.md` から変更）
- **配置場所**: `.github/agents/` ディレクトリ
- **構造**: YAMLフロントマター + Markdownボディ

#### 2. フロントマターの設定項目
| フィールド | 説明 |
|-----------|------|
| `description` | エージェントの簡潔な説明（チャット入力フィールドにプレースホルダーとして表示） |
| `name` | エージェント名（未指定時はファイル名を使用） |
| `argument-hint` | ユーザーガイダンス用のヒントテキスト |
| `tools` | 利用可能なツールリスト（MCP含む、`<server name>/*`形式でサーバー全体指定可） |
| `model` | 使用するAIモデル（未指定時は現在選択中のモデル） |
| `target` | ターゲット環境（`vscode` or `github-copilot`） |
| `mcp-servers` | MCPサーバー設定（JSON形式） |
| `handoffs` | 他エージェントへのハンドオフ設定 |

#### 3. ハンドオフ機能
エージェント間のシームレスなワークフロー遷移を実現：
- `label`: ハンドオフボタンのラベル
- `agent`: 遷移先エージェントID
- `prompt`: 遷移先に送るプロンプト
- `send`: 自動送信フラグ（true/false）

### コミュニティベストプラクティス（github/awesome-copilot より）

#### 1. プランニング専用エージェントの特徴
- **読み取り専用ツールに限定**: 誤ったコード変更を防止
- **明確なモード区分**: Plan Mode と Act Mode を分離
- **構造化された出力**: Markdownドキュメントとして計画を出力

#### 2. 効果的なエージェント設計パターン

##### a) Tool Usage Policy の明示
```markdown
## Tool Usage Policy
- Safety: Strong bias against unsafe commands unless explicitly required
- Parallelize: Batch read-only reads and independent edits
- Docs: Fetch latest libs/frameworks/deps with websearch and fetch
```

##### b) インタラクションパターンの定義
```markdown
### When Starting a New Task
1. Understand the Goal
2. Explore Context
3. Identify Constraints
4. Clarify Scope
```

##### c) 品質基準の明確化
```markdown
## Quality Standards
- Use specific action verbs
- Include exact file paths
- Ensure success criteria are measurable
```

---

## 現状分析

### 現在のエージェント (`plan-creater.agent.md`) の構成

#### 良い点
1. `description` が設定されている
2. `model` でClaude Opus 4.5が指定されている
3. 豊富なMCPツールが設定されている
4. 日本語で明確なプロセスが定義されている

#### 改善点

| 項目 | 現状 | 改善案 |
|-----|------|-------|
| `name` フィールド | 未設定 | 「Plan Creator - プラン作成エージェント」を追加 |
| `argument-hint` | 未設定 | ユーザーガイダンスを追加 |
| `target` フィールド | 未設定 | `vscode` を明示的に設定 |
| `handoffs` | 未設定 | 実装エージェントへのハンドオフを追加 |
| ツール設定 | 全編集系ツールを含む | 読み取り専用 + Markdown編集に必要なツールのみ |
| Tool Usage Policy | 未定義 | 明示的なポリシーを追加 |
| 出力フォーマット | 未定義 | 構造化されたプランテンプレートを追加 |
| 品質基準 | 未定義 | 測定可能な成功基準を追加 |

---

## 現行ツールの棚卸しと選定

### 現在設定されているツール一覧

| ツール | カテゴリ | 残す/除外 | 理由 |
|--------|----------|-----------|------|
| `runCommands` | 実行系 | **除外** | コマンド実行はプラン作成に不要 |
| `runTasks` | 実行系 | **除外** | タスク実行はプラン作成に不要 |
| `edit` | 編集系 | **残す** | プランMarkdownの編集に必要 |
| `runNotebooks` | 実行系 | **除外** | ノートブック実行はプラン作成に不要 |
| `search` | 情報収集 | **残す** | コードベース検索に必要 |
| `new` | 編集系 | **残す** | 新規プランファイル作成に必要 |
| `context7/*` | 情報収集 | **残す** | 最新ドキュメント取得に必要 |
| `msdocs/*` | 情報収集 | **残す** | Microsoft公式ドキュメント参照 |
| `usages` | 情報収集 | **残す** | シンボル参照の調査に必要 |
| `problems` | 情報収集 | **残す** | エラー・警告の確認に必要 |
| `changes` | 情報収集 | **残す** | Git差分の確認に必要 |
| `testFailure` | 情報収集 | 除外 | テスト実行結果はプラン作成に不要 |
| `openSimpleBrowser` | 情報収集 | 除外 | ブラウザ表示はプラン作成に不要 |
| `fetch` | 情報収集 | **残す** | Web情報取得に必要 |
| `githubRepo` | 情報収集 | **残す** | GitHubリポジトリ検索に必要 |
| `todos` | タスク管理 | **残す** | タスク進捗管理に必要 |
| `runSubagent` | 実行系 | **残す** | 複雑な調査タスクの委譲に必要 |
| `github-mcp-server/*` | 情報収集 | **残す（一部）** | GitHub情報取得に必要 |
| `serena/*` | 情報収集 | **残す** | コード分析に必要 |

### 選定後のツールセット

```yaml
tools: [
  # 情報収集・検索系
  'search',
  'usages',
  'problems',
  'changes',
  'fetch',
  'githubRepo',
  'runSubagent',
  
  # Markdown編集系（プラン作成に必須）
  'edit',
  'new',
  
  # タスク管理
  'todos',
  
  # MCP: ドキュメント参照
  'context7/*',
  'msdocs/*',
  
  # MCP: GitHub情報取得（読み取り専用のみ）
  'github-mcp-server/search_code',
  'github-mcp-server/search_issues',
  'github-mcp-server/search_pull_requests',
  'github-mcp-server/search_repositories',
  'github-mcp-server/list_commits',
  'github-mcp-server/list_issues',
  'github-mcp-server/list_pull_requests',
  'github-mcp-server/get_file_contents',
  'github-mcp-server/issue_read',
  'github-mcp-server/pull_request_read',
  
  # MCP: コード分析
  'serena/*'
]
```

---

## 改善プラン

### Phase 1: フロントマターの強化

#### アクション 1.1: 基本フィールドの追加
- [ ] `name` フィールドを追加
- [ ] `argument-hint` フィールドを追加
- [ ] `target: vscode` フィールドを追加

**修正後のフロントマター:**
```yaml
---
description: 'プラン作成エージェント - タスク分析とベストプラクティスに基づく実行可能なプランを生成'
name: 'Plan Creator - プラン作成エージェント'
argument-hint: 'タスクの目的や要件を入力してください（例: "新機能Xの実装計画を作成して"）'
model: 'Claude Opus 4.5 (Preview)'
target: vscode
tools: [
  # 情報収集・検索系
  'search',
  'usages',
  'problems',
  'changes',
  'fetch',
  'githubRepo',
  'runSubagent',
  # Markdown編集系（プラン作成に必須）
  'edit',
  'new',
  # タスク管理
  'todos',
  # MCP: ドキュメント参照
  'context7/*',
  'msdocs/*',
  # MCP: GitHub情報取得（読み取り専用）
  'github-mcp-server/search_code',
  'github-mcp-server/search_issues',
  'github-mcp-server/search_pull_requests',
  'github-mcp-server/search_repositories',
  'github-mcp-server/list_commits',
  'github-mcp-server/list_issues',
  'github-mcp-server/list_pull_requests',
  'github-mcp-server/get_file_contents',
  'github-mcp-server/issue_read',
  'github-mcp-server/pull_request_read',
  # MCP: コード分析
  'serena/*'
]
handoffs:
  - label: 'プラン実行を開始'
    agent: 'agent'
    prompt: '上記のプランに従って実装を開始してください。'
    send: false
  - label: 'プランをレビュー'
    agent: 'ask'
    prompt: '上記のプランをレビューして、改善点があれば指摘してください。'
    send: false
---
```

#### アクション 1.2: 除外ツールの確認
除外するツールが他の機能に影響しないことを確認：

| 除外ツール | 影響確認 | 代替手段 |
|-----------|---------|---------|
| `runCommands` | プラン作成に影響なし | ハンドオフ後のAgentモードで実行 |
| `runTasks` | プラン作成に影響なし | ハンドオフ後のAgentモードで実行 |
| `runNotebooks` | プラン作成に影響なし | 必要時はAgentモードで実行 |
| `testFailure` | テスト結果参照不可 | `problems` でエラー確認、詳細はAgentモードで |
| `openSimpleBrowser` | プレビュー不可 | `fetch` でコンテンツ取得可能 |

#### アクション 1.3: ハンドオフ動作確認
- [ ] 実装後、`handoffs` の `agent: 'agent'` と `agent: 'ask'` が正しく動作することを検証
  - 確認観点: ハンドオフボタンが表示されるか、遷移先が期待通りか

### Phase 2: 本文（Instructions）の強化

#### アクション 2.1: Tool Usage Policy の追加
- [ ] ツール使用ポリシーを明示的に定義

```markdown
## ツール使用ポリシー

### 許可されたツール

#### 情報収集（並列実行推奨）
- `search`: コードベース検索
- `usages`: シンボル参照の調査
- `problems`: エラー・警告の確認
- `changes`: Git差分の確認
- `fetch`: Web情報取得
- `githubRepo`: GitHubリポジトリ検索
- `runSubagent`: 複雑な調査タスクの委譲
- `context7/*`: 最新ライブラリドキュメント取得（優先使用）
- `msdocs/*`: Microsoft公式ドキュメント参照
- `github-mcp-server/*`: GitHub情報取得（読み取り専用）
- `serena/*`: コード分析

#### Markdown編集（プラン出力用）
- `edit`: 既存プランファイルの編集
- `new`: 新規プランファイルの作成

#### タスク管理
- `todos`: タスク進捗管理

### 禁止されたツール（除外済み）
以下はプラン作成モードでは使用不可。ハンドオフ後のAgentモードで実行すること：
- `runCommands`: ターミナルコマンド実行
- `runTasks`: VSCodeタスク実行
- `runNotebooks`: ノートブック実行
- `testFailure`: テスト失敗情報（`problems`で代替）
- `openSimpleBrowser`: ブラウザ表示（`fetch`で代替）

### ツール使用の注意事項
1. 情報収集は**並列実行**を推奨（独立したクエリは同時実行）
2. 最新のベストプラクティスを取得するために**Context7を優先使用**
3. `edit`/`new`は**Markdownファイル（プラン）のみ**に使用
4. ソースコードの編集は**絶対に行わない**（ハンドオフ後に実行）
```

#### アクション 2.2: 出力フォーマットの標準化
- [ ] プランドキュメントのテンプレートを追加

```markdown
## プラン出力フォーマット

プランは `ai/plans/` ディレクトリに以下の命名規則で保存：
- ファイル名: `YYMMDD_[タスク概要]_v[バージョン].md`
- バージョン: `v1`, `v2`, ... （同一タスクの改訂版を区別）
- 例: `251202_認証機能実装プラン_v1.md`、`251202_認証機能実装プラン_v2.md`

プランは以下の構造で作成すること：

### 1. 概要
- 目的: [タスクの目的を1文で説明]
- スコープ: [対象範囲]
- 前提条件: [必要な前提条件]

### 2. 要件と制約
| ID | 種別 | 内容 |
|----|------|------|
| REQ-001 | 要件 | [要件内容] |
| CON-001 | 制約 | [制約内容] |

### 3. 実装ステップ
#### Phase 1: [フェーズ名]
- [ ] TASK-001: [タスク内容]
  - 対象ファイル: [ファイルパス]
  - 完了条件: [測定可能な条件]

### 4. テスト計画
- [ ] TEST-001: [テスト内容]

### 5. 成功基準
- [測定可能な成功基準]

### 6. リスクと対策
| リスク | 影響度 | 対策 |
|--------|--------|------|
| [リスク内容] | 高/中/低 | [対策内容] |

### 7. 次のアクション
- [ ] [具体的なアクション]
```

#### アクション 2.3: インタラクションパターンの定義
- [ ] タスク開始時の情報収集ガイドラインを追加

```markdown
## インタラクションパターン

### 新規タスク開始時
1. **目的の理解**: ユーザーの要求を明確化
2. **コンテキストの探索**: 関連ファイル、コンポーネント、システムの把握
3. **制約の特定**: 技術的・ビジネス的制約の確認
4. **スコープの明確化**: 変更範囲の定義

### 情報不足時
1. 具体的な質問をバッチでまとめて提示
2. 不明点は`TBD`としてマークし、後で確認
3. 仮定を立てる場合は明示的に記載

### 複雑なタスク対応時
1. 問題を小さな部分に分解
2. 既存のパターンや解決策を調査
3. トレードオフを評価
4. 複数のアプローチを提案
```

#### アクション 2.4: 品質基準の追加
- [ ] プランの品質基準を定義

```markdown
## 品質基準

### アクション可能なプラン
- 具体的なアクション動詞を使用（作成、修正、更新、テスト、設定）
- 正確なファイルパスを含める
- 成功基準は測定可能で検証可能であること
- フェーズは論理的に積み上げられていること

### リサーチドリブンな内容
- 検証済みの情報のみを含める
- 具体的な例やパターンを参照
- 仮定的な内容は避ける

### 実装準備完了
- 即座に作業開始できる詳細度
- すべての依存関係とツールを特定
- フェーズ間にギャップがないこと
```

### Phase 3: 運用改善

#### アクション 3.0: テンプレートディレクトリの作成
- [ ] `ai/templates/` ディレクトリを作成（存在しない場合）

#### アクション 3.1: プランテンプレートファイルの作成
- [ ] `ai/templates/plan-template.md` を作成

**テンプレート内容:**
```markdown
# [タスク名] プラン

作成日: YYYY年MM月DD日  
作成者: [エージェント名/ユーザー名]  
ステータス: Draft / Review / Approved / In Progress / Completed

## 1. 概要

### 目的
[タスクの目的を1〜2文で説明]

### スコープ
- 対象: [対象範囲]
- 対象外: [明示的に除外する範囲]

### 前提条件
- [前提条件1]
- [前提条件2]

## 2. 要件と制約

| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | [要件内容] | 高/中/低 |
| CON-001 | 制約 | [制約内容] | - |
| GUD-001 | ガイドライン | [ガイドライン内容] | - |

## 3. 実装ステップ

### Phase 1: [フェーズ名]
**目標**: [このフェーズの目標]

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-001 | [タスク内容] | [ファイルパス] | [測定可能な条件] | [ ] |

### Phase 2: [フェーズ名]
**目標**: [このフェーズの目標]

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-002 | [タスク内容] | [ファイルパス] | [測定可能な条件] | [ ] |

## 4. テスト計画

| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-001 | 単体 | [テスト内容] | [期待結果] |
| TEST-002 | 統合 | [テスト内容] | [期待結果] |

## 5. 成功基準

- [ ] [測定可能な成功基準1]
- [ ] [測定可能な成功基準2]

## 6. リスクと対策

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| RISK-001 | [リスク内容] | 高/中/低 | 高/中/低 | [対策内容] |

## 7. 依存関係

- [依存するタスク/システム/リソース]

## 8. 次のアクション

1. [ ] [具体的なアクション1]
2. [ ] [具体的なアクション2]

---
*このプランは Plan Creator エージェントによって作成されました*
```

**テンプレート管理方針:**
- テンプレートのバージョン管理: Git履歴で追跡
- 更新通知: プランエージェントの指示文に最新テンプレートを参照する記述を追加
- バリエーション: 必要に応じてタスク種別ごとのサブテンプレートを `ai/templates/` に追加

#### アクション 3.2: カスタムインストラクションとの連携
- [ ] `.github/copilot-instructions.md` に以下を追加検討:

```markdown
## プラン作成ガイドライン
- プランは `ai/plans/` ディレクトリに保存
- ファイル命名規則: `YYMMDD_[タスク概要]_v[バージョン].md`
- テンプレート: `ai/templates/plan-template.md` を参照
```

#### アクション 3.3: レビュー専用エージェントの分離検討
- [ ] プランレビュー専用の `plan-reviewer.agent.md` を作成検討
  - 優先度: 低（現状はハンドオフで `ask` モードを使用）
  - 将来的にレビュー観点の標準化が必要になった場合に作成

---

## 実装スケジュール

| Phase | 内容 | 優先度 | 工数目安 | 担当 |
|-------|------|--------|----------|------|
| Phase 1 | フロントマター強化 | 高 | 30分 | AI Agent |
| Phase 2 | 本文強化 | 高 | 1時間 | AI Agent |
| Phase 3a | 運用改善（テンプレート作成） | 中 | 30分 | AI Agent |
| Phase 3b | 運用改善（copilot-instructions連携） | 低 | 15分 | AI Agent |

---

## 成功基準

1. **定量的指標**
   - プラン作成時間の短縮（目標: 20%削減）
   - プラン実行時のエラー削減（目標: 30%削減）
   - ツール使用エラーの発生ゼロ（除外ツール呼び出しなし）

2. **定性的指標**
   - プランの構造が一貫している
   - 実装エージェントへのハンドオフがスムーズ
   - ユーザーからの確認事項が減少
   - ソースコードへの誤編集がゼロ

---

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| ツール制限により情報収集が不十分 | 中 | `runSubagent`で複雑な調査を委譲、必要に応じてツール追加 |
| ハンドオフが複雑になりすぎる | 低 | シンプルな2択（実行/レビュー）から開始 |
| 出力フォーマットが硬直的 | 中 | テンプレートのバリエーションを用意（Phase 3で対応） |
| Markdown以外のファイル編集が必要になる | 低 | ハンドオフ後のAgentモードで対応 |
| `changes`ツールで差分確認後に編集したくなる | 中 | ツールポリシーで明示的に禁止、ハンドオフを促す |

---

## 参考資料

- [VS Code Custom Agents 公式ドキュメント](https://code.visualstudio.com/docs/copilot/customization/custom-agents)
- [github/awesome-copilot リポジトリ](https://github.com/github/awesome-copilot)
- [anchildress1/awesome-github-copilot リポジトリ](https://github.com/anchildress1/awesome-github-copilot)

---

## 次のアクション

1. ~~本プランのレビューを実施~~ ✅ 完了（2025-12-02）
2. [ ] Phase 1 の実装を開始（フロントマター更新）
3. [ ] Phase 2 の実装（本文にツールポリシー・出力フォーマット追加）
4. [ ] Phase 3 の実装（テンプレートファイル作成）
5. [ ] 実際のタスクで効果を検証
6. [ ] フィードバックに基づいて調整

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-12-02 | 初版作成 |
| 2025-12-02 | レビュー結果反映: `target`フィールド追加、ツール棚卸し実施、テンプレート詳細化 |
| 2025-12-02 | レビュー結果反映: ファイル命名規則にバージョン追加、ディレクトリ作成タスク追加、ハンドオフ動作確認追加 |
| 2025-12-02 | レビュー v2 対応: アクション3.2の命名規則表記ゆれ修正、実装スケジュールのPhase番号を一意化（3a/3b） |
