# プラン作成エージェント パフォーマンス向上プラン

作成日: 2025年12月2日  
作成者: Plan Creator エージェント  
ステータス: Review（レビュー完了）

## 1. 概要

### 目的
プラン作成エージェント（`plan-creater.agent.md`）のパフォーマンスをさらに向上させ、より効率的かつ高品質なプラン生成を実現する。

### スコープ
- 対象: `.github/agents/plan-creater.agent.md` の本文（Instructions）
- 対象外: フロントマター設定（既に最適化済み）、新規エージェントの作成

### 前提条件
- 既存の改善プラン（`251202_プラン作成エージェント改善プラン.md`）が適用済み
- ツール設定とハンドオフ設定は適切に構成されている

## 2. 調査結果

### ベストプラクティス分析（github/awesome-copilot より）

#### 2.1 Blueprint Mode の特徴
- **ワークフロー選択**: タスクの複雑さに応じて4種類のワークフロー（Loop/Debug/Express/Main）を使い分け
- **並列化の徹底**: 独立した読み取り操作は常に並列実行
- **自己検証**: 6カテゴリのルーブリックで品質を自動チェック
- **信頼度ベースの判断**: 90%以上の信頼度で自律進行、それ以下で質問

#### 2.2 Task Planner の特徴
- **リサーチ検証**: プラン作成前に必ずリサーチの存在と完全性を検証
- **ファイル分離**: プラン、詳細、実装プロンプトを別ファイルで管理
- **行番号参照**: 参照先の正確な行番号を維持

#### 2.3 Plan Mode の特徴
- **Think First, Code Later**: 実装前の分析と計画を最優先
- **Collaborative Strategy**: ユーザーとの対話的なアプローチ
- **明確なワークフローステップ**: 各フェーズで何を行うか詳細に定義

### 現状との差分分析

| 項目 | 現状 | ベストプラクティス | ギャップ |
|------|------|-------------------|----------|
| 並列化 | 「並列実行推奨」の記載のみ | 具体的な並列実行パターンと例 | あり |
| ワークフロー | 単一プロセス | 複雑度に応じた複数ワークフロー | あり |
| 自己検証 | なし | 品質ルーブリックによる自動チェック | あり |
| リサーチ検証 | 暗黙的 | 明示的な検証ステップ | あり |
| 信頼度判断 | なし | 数値ベースの判断基準 | 今回は採用しない（※1） |
| エラーリカバリ | なし | 失敗時のリトライ戦略 | 今回は採用しない（※1） |

> ※1: 複雑化を避けるため、信頼度スコアによる分岐とエラーリカバリは今回のスコープ外とする。将来的に必要になった場合に別途検討。

## 3. 要件と制約

| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | 並列実行パターンを具体化し、情報収集を高速化する | 高 |
| REQ-002 | 要件 | タスク複雑度に応じたワークフロー選択を導入する | 中 |
| REQ-003 | 要件 | 自己検証プロセスを追加し、プラン品質を保証する | 中 |
| REQ-004 | 要件 | リサーチ検証ステップを明示化する | 中 |
| CON-001 | 制約 | 既存のプロセス定義との整合性を維持する | - |
| CON-002 | 制約 | 指示文の複雑さを過度に増やさない | - |
| CON-003 | 制約 | 信頼度スコアによる分岐は採用しない（複雑化回避） | - |
| GUD-001 | ガイドライン | 日本語で簡潔に記述する | - |

## 4. 実装ステップ

### Phase 1: 並列化パターンの具体化
**目標**: 情報収集時間の短縮（目標: 3倍高速化）

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-001 | 並列実行パターンの詳細を追加 | `.github/agents/plan-creater.agent.md` | 3つ以上の並列実行例が記載されている | [x] |
| TASK-002 | 依存関係がある場合の順次実行ガイドを追加 | 同上 | 順次実行が必要なケースが明記されている | [x] |

**追加するコンテンツ案:**

以下を `plan-creater.agent.md` の「情報収集の方針」セクション配下に追加する。

```markdown
### 並列実行パターン

#### 推奨: 独立した情報収集は並列実行
- 複数ファイルの読み取り → 同時に3-5ファイルを読み取り
- 複数のコードベース検索 → 異なるキーワードで同時検索
- 複数のMCPツール呼び出し → context7とmsdocsを同時使用

#### 順次実行が必要なケース
- 検索結果に基づくファイル読み取り
- 依存関係のあるシンボル調査
- 前のステップの結果が次のステップの入力になる場合
```

### Phase 2: ワークフロー選択の導入
**目標**: タスクの複雑さに応じた効率的なプロセス選択

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-003 | ワークフロー選択基準を定義 | `.github/agents/plan-creater.agent.md` | 3種類のワークフローが定義されている | [x] |
| TASK-004 | 各ワークフローのプロセスを記述 | 同上 | 各ワークフローのステップが明確 | [x] |

**追加するコンテンツ案:**

以下を `plan-creater.agent.md` の「プロセス」セクションの前に新規セクションとして追加する。  
※ワークフローは既存の「プラン作成プロセス」等を内側で実行する"モード区分"として扱う。

```markdown
## ワークフロー選択

タスクの規模に応じてワークフローを選択し、その中で既存の「プラン作成プロセス」「レビュープロセス」「修正プロセス」を実行する。

### タスク分析後に適切なワークフローを選択

#### Express（簡易プラン）
- **条件**: 変更対象が2ファイル以下、影響範囲が限定的
- **プロセス**: 情報収集 → プラン作成 → 出力
- **所要時間目安**: 5分以内

#### Standard（標準プラン）
- **条件**: 中程度の複雑さ、3-10ファイルに影響
- **プロセス**: 目的理解 → 情報収集 → 設計検討 → プラン作成 → 検証 → 出力
- **所要時間目安**: 10-20分

#### Comprehensive（詳細プラン）
- **条件**: アーキテクチャ変更、多数のファイルに影響
- **プロセス**: 目的理解 → 詳細調査 → 設計検討 → リスク分析 → プラン作成 → 複数回検証 → 出力
- **所要時間目安**: 30分以上
```

### Phase 3: 自己検証プロセスの追加
**目標**: プラン品質の一貫性向上

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-005 | 品質チェックリストを定義 | `.github/agents/plan-creater.agent.md` | 5項目以上のチェック基準が定義されている | [x] |
| TASK-006 | 検証プロセスをワークフローに組み込み | 同上 | 各ワークフローに検証ステップが含まれている | [x] |

**追加するコンテンツ案:**
```markdown
## 自己検証プロセス

プラン出力前に以下の項目を確認:

### 品質チェックリスト
1. **完全性**: すべての要件がプランに反映されているか？
2. **アクション可能性**: 各タスクは具体的なアクション動詞で始まっているか？
3. **測定可能性**: 完了条件は客観的に判断可能か？
4. **依存関係**: タスク間の依存関係が正しく反映されているか？
5. **リスク対応**: 主要なリスクに対する対策が含まれているか？

### 検証結果の対応
- すべてチェック通過 → プラン出力
- 1-2項目の問題 → 該当部分を修正して再検証
- 3項目以上の問題 → プラン全体を見直し
```

### Phase 4: リサーチ検証の明示化
**目標**: 情報不足によるプラン品質低下の防止

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-007 | リサーチ検証チェックポイントを定義 | `.github/agents/plan-creater.agent.md` | 情報収集の完了基準が明記されている | [x] |
| TASK-008 | 情報不足時の対応フローを追加 | 同上 | 情報不足時の判断基準と対応が明記されている | [x] |

**追加するコンテンツ案:**
```markdown
## リサーチ検証

### 情報収集完了の判断基準

プラン作成に進む前に、以下の情報が揃っていることを確認:

| 項目 | 必須 | 確認方法 |
|------|------|---------|
| 対象ファイルの特定 | ○ | `search`ツールで関連ファイルを特定済み |
| 既存パターンの把握 | ○ | 類似実装のコードを確認済み |
| 依存関係の理解 | ○ | `usages`ツールで参照関係を確認済み |
| 技術的制約の把握 | ○ | ドキュメントまたはコードから確認済み |
| ベストプラクティスの調査 | △ | `context7`または`msdocs`で最新情報を取得 |

### 情報不足時の対応

- **軽微な不足**: プランに「TBD」としてマークし、ハンドオフ時に確認を促す
- **重大な不足**: ユーザーに追加情報を求める（1-2個の具体的な質問に絞る）
- **調査で解決可能**: `runSubagent`で専門的な調査を委譲
```

## 5. テスト計画

| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-001 | 機能 | 簡単なタスクでExpressワークフローが選択されるか | 5分以内にプラン生成完了 |
| TEST-002 | 機能 | 複雑なタスクでComprehensiveワークフローが選択されるか | 詳細な分析とリスク評価が含まれるプラン生成 |
| TEST-003 | 品質 | 並列実行により情報収集時間が短縮されるか | 改善前の同一タスクでのツール呼び出し回数・応答時間と比較して3倍以上の高速化 |
| TEST-004 | 品質 | 自己検証により低品質なプランが出力されないか | すべてのプランが5項目チェックを通過 |

## 6. 成功基準

- [x] 並列実行パターンが具体的に記述されている
- [x] 3種類のワークフローが定義され、選択基準が明確
- [x] 5項目以上の品質チェックリストが実装されている
- [x] リサーチ検証の完了基準が明確に定義されている
- [ ] テストシナリオで期待通りの動作を確認

## 7. リスクと対策

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| RISK-001 | 指示文が複雑になりすぎてエージェントのパフォーマンスが低下 | 中 | 中 | 各セクションを簡潔に保ち、必要最小限の内容に絞る |
| RISK-002 | ワークフロー選択の判断基準が曖昧で誤った選択をする | 中 | 低 | 具体的な数値基準（ファイル数、影響範囲）を設定 |
| RISK-003 | 自己検証が厳格すぎてプラン生成が遅くなる | 低 | 低 | 検証項目を5項目に限定し、効率を維持 |

## 8. 依存関係

- 既存の改善プラン（`251202_プラン作成エージェント改善プラン.md`）が適用済みであること
- エージェントファイル（`.github/agents/plan-creater.agent.md`）が最新状態であること

## 9. 次のアクション

1. [x] 本プランのレビュー実施
2. [x] Phase 1-2 の実装（並列化パターン＋ワークフロー選択）
3. [x] Phase 3-4 の実装（自己検証＋リサーチ検証）
4. [ ] テストシナリオによる検証
5. [ ] フィードバックに基づく調整

### 実装単位の推奨
- **Phase 1-2**: 基盤となる効率化機能のため、一括でコミット/PR作成を推奨
- **Phase 3-4**: 品質保証機能のため、Phase 1-2 適用後に一括でコミット/PR作成を推奨

---

## 参考資料

- [github/awesome-copilot - blueprint-mode.agent.md](https://github.com/github/awesome-copilot/blob/main/agents/blueprint-mode.agent.md)
- [github/awesome-copilot - task-planner.agent.md](https://github.com/github/awesome-copilot/blob/main/agents/task-planner.agent.md)
- [github/awesome-copilot - plan.agent.md](https://github.com/github/awesome-copilot/blob/main/agents/plan.agent.md)
- [VS Code Custom Agents 公式ドキュメント](https://code.visualstudio.com/docs/copilot/customization/custom-agents)

---
*このプランは Plan Creator エージェントによって作成されました*
