# PRレビューエージェント精度向上プラン v2

作成日: 2025年12月10日
作成者: Plan Creator エージェント
ステータス: Approved
更新日: 2025年12月10日（レビュー指摘反映）

## 1. 概要

### 目的
Claude Code の pr-reviewer エージェント（`.claude/agents/pr-reviewer.md`）のレビュー精度を向上させる。Claude Code 特有の機能（スラッシュコマンド、フック）を活用し、より実用的で一貫性のあるレビューを実現する。

### スコープ
- 対象: `.claude/agents/pr-reviewer.md`
- 対象: `.claude/commands/review.md`（新規作成）
- 対象: `.claude/hooks/post-review.sh`（新規作成）
- 対象: `ai/review-metrics/`（ディレクトリ作成）
- 対象外: Copilot用エージェント（`.github/agents/`）

### 前提条件
- Claude Code CLI がセットアップ済み
- MCP サーバー（github-mcp-server, serena, context7, msdocs）が利用可能
- プロジェクトで Claude Code エージェントが有効化されている

## 2. 現状分析

### 既存の改善プラン状況

| プラン | 作成日 | ステータス | 内容 |
|--------|--------|----------|------|
| 251202_PRレビューエージェント精度向上プラン.md | 2024-12-02 | Ready for Implementation | Serena MCP活用、段階的プロセス、計測データ出力 |
| 251202_プルリクエストレビューエージェント改善プラン.md | 2025-12-02 | Completed | メタデータ整理、ワークフロー選択、品質検証 |

### GAP分析（Claude Code版 vs Copilot版）

| 項目 | Claude Code版 | Copilot版 | GAP |
|------|--------------|----------|-----|
| 定義詳細度 | 約291行 | 615行 | **大** |
| Serena MCP活用 | 概要のみ | 詳細ガイドライン | **大** |
| エビデンス要件 | 基本定義 | 詳細例付き | **中** |
| エラーハンドリング | なし | フォールバック戦略 | **大** |
| 計測データ出力 | 言及のみ | JSON仕様定義 | **中** |
| スラッシュコマンド | なし | - | **新規機会** |
| フック連携 | なし | - | **新規機会** |

### 未活用のClaude Code機能

1. **スラッシュコマンド**: `/review` コマンドでPRレビューを簡単に開始できる
2. **フック**: レビュー前後の自動処理（環境準備、結果保存）
3. **エージェント間連携**: plan-creator との連携でアーキテクチャ整合性を評価

## 3. 要件と制約

| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | `/review` スラッシュコマンドを作成 | 高 |
| REQ-002 | 要件 | pr-reviewer.md にエラーハンドリング・フォールバック戦略を追加 | 高 |
| REQ-003 | 要件 | Serena MCP 活用の詳細ガイドラインを追加 | 高 |
| REQ-004 | 要件 | エビデンスベースのフィードバック例を追加 | 中 |
| REQ-005 | 要件 | 計測データ出力ディレクトリを作成 | 中 |
| REQ-006 | 要件 | レビュー後の自動保存フックを作成 | 低 |
| CON-001 | 制約 | 既存の段階的プロセス（5フェーズ）を維持 | - |
| CON-002 | 制約 | 既存のワークフロー選択（Quick/Standard/Deep）を維持 | - |
| GUD-001 | ガイドライン | Copilot版の詳細定義を参考に Claude Code 版を強化 | - |

### 要件↔タスク トレーサビリティ

| 要件ID | 対応タスク | 検証テスト |
|--------|-----------|-----------|
| REQ-001 | TASK-001, TASK-002, TASK-003 | TEST-001, TEST-002 |
| REQ-002 | TASK-004, TASK-007 | TEST-006, TEST-009 |
| REQ-003 | TASK-005 | TEST-003, TEST-004, TEST-007 |
| REQ-004 | TASK-006 | TEST-003, TEST-004, TEST-007 |
| REQ-005 | TASK-008, TASK-009, TASK-010 | TEST-005 |
| REQ-006 | TASK-011, TASK-012 | TEST-010 |

## 4. 実装ステップ

### Phase 1: スラッシュコマンドの作成
**目標**: `/review` コマンドでPRレビューを簡単に開始できるようにする

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-001 | `/review` コマンドファイルを作成 | `.claude/commands/review.md` | `claude /help` でコマンドがリストに表示される | [ ] |
| TASK-002 | PR番号/URLを引数として受け取れるようにする | `.claude/commands/review.md` | `/review #123` でPR情報がGitHub MCPから取得される | [ ] |
| TASK-003 | plan-creator 同様のワークフロー選択ロジックを組み込む | `.claude/commands/review.md` | 変更規模に応じてQuick/Standard/Deepが自動選択される | [ ] |

**新規ファイル: `.claude/commands/review.md`**:
```markdown
---
name: review
description: PRをレビューする（PR番号またはURLを指定）
allowed-tools: Read, Grep, Glob, Write, Bash, mcp__context7, mcp__msdocs, mcp__github-mcp-server, mcp__serena
model: opus
argument-hint: PR番号またはURL（例: "#123" または "https://github.com/owner/repo/pull/123"）
---

## コンテキスト
- プロジェクト: @CLAUDE.md
- エージェント定義: @.claude/agents/pr-reviewer.md
- 出力先: ai/reviews/

## タスク
以下のステップでPRレビューを実施:

1. **PR情報取得**: GitHub MCP で PR 情報を取得
2. **ワークフロー選択**: 変更規模に応じて Quick/Standard/Deep を選択
3. **段階的レビュー**: pr-reviewer エージェントの5フェーズプロセスを実行
4. **結果出力**: ai/reviews/ にMarkdown形式で保存
5. **計測データ保存**: ai/review-metrics/ にJSON形式で保存
```

### Phase 2: エージェント定義の強化
**目標**: pr-reviewer.md にエラーハンドリングとSerena MCP詳細ガイドラインを追加

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-004 | エラーハンドリング・フォールバック戦略セクションを追加 | `.claude/agents/pr-reviewer.md` | エラー時の対応が明記される | [ ] |
| TASK-005 | Serena MCP 活用の詳細ガイドライン（ツール名、使用例）を追加 | `.claude/agents/pr-reviewer.md` | 具体的な使用例が含まれる | [ ] |
| TASK-006 | エビデンスベースのフィードバック例を追加（カテゴリ別） | `.claude/agents/pr-reviewer.md` | code_quality/security/performance/test/design各1例が含まれる | [ ] |
| TASK-007 | タイムアウト設定セクションを追加 | `.claude/agents/pr-reviewer.md` | タイムアウト値が明記され、計測データへの記録方法が含まれる | [ ] |

**追加セクション（エラーハンドリング）**:
```markdown
## エラーハンドリングとフォールバック

### MCP接続エラー時の対応

**Serena MCP失敗時**:
1. エラーをログに記録（計測データのerrorsフィールドに追加）
2. フォールバック: `Read`ツールでファイル全体を読み取り
3. `Grep`ツールで依存関係を追跡
4. レビュー続行（Phase 2の完了条件を調整）

**msdocs/context7 MCP失敗時**:
1. エラーをログに記録
2. フォールバック: 一般的なベストプラクティスを適用
3. エビデンスなしの指摘として記録
4. レビュー続行

**GitHub MCP失敗時**:
1. エラーをログに記録
2. フォールバック: `gh` CLIコマンドでPR情報を取得
3. 取得できない場合はレビュー中断、エラーを報告

### タイムアウト設定
- Serena MCP各呼び出し: 30秒
- msdocs/context7検索: 20秒
- GitHub MCP呼び出し: 30秒
- 全体レビュー: Quick 5分 / Standard 15分 / Deep 30分

**注**: タイムアウト値は計測データの `metrics.timeouts` フィールドに記録すること
```

### Phase 3: インフラ整備
**目標**: 計測データ出力用ディレクトリとフックを作成

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-008 | 計測データ出力ディレクトリを作成 | `ai/review-metrics/` | ディレクトリが存在する | [ ] |
| TASK-009 | 計測データフォーマット仕様を作成（errorsスキーマ含む） | `ai/review-metrics/README.md` | JSON仕様・errorsスキーマが明記される | [ ] |
| TASK-010 | レビュー結果ディレクトリ確認 | `ai/reviews/` | ディレクトリが存在する | [ ] |
| TASK-011 | レビュー後自動保存フックを作成 | `.claude/hooks/post-review.sh` | フックファイルが存在し実行可能 | [ ] |
| TASK-012 | フックの動作確認 | `.claude/hooks/post-review.sh` | レビュー完了後にフックが実行される | [ ] |

**新規ファイル: `ai/review-metrics/README.md`**:
```markdown
# レビュー計測データ

## フォーマット仕様

ファイル名: `review_<PR番号>_<YYYYMMDD>_<HHmmss>.json`

```json
{
  "pr_number": 123,
  "review_date": "2025-12-10T10:30:00Z",
  "pr_size": "small|medium|large",
  "workflow": "quick|standard|deep",
  "changed_files": 3,
  "diff_lines": 150,
  "review_duration_sec": 180,
  "findings": [
    {
      "severity": "high|medium|low",
      "category": "code_quality|security|performance|test|design",
      "has_evidence": true,
      "evidence_url": "https://..."
    }
  ],
  "metrics": {
    "total_findings": 5,
    "findings_with_evidence": 4,
    "evidence_ratio": 0.80,
    "mcp_calls": {
      "serena": 3,
      "msdocs": 1,
      "context7": 2,
      "github": 5
    },
    "timeouts": {
      "serena_ms": 30000,
      "msdocs_ms": 20000,
      "context7_ms": 20000,
      "github_ms": 30000
    },
    "errors": [
      {
        "source": "serena|msdocs|context7|github",
        "code": "TIMEOUT|CONNECTION_ERROR|AUTH_ERROR|UNKNOWN",
        "message": "エラーの詳細説明",
        "fallback_used": true,
        "fallback_method": "Read|Grep|gh_cli|general_best_practice",
        "timestamp": "2025-12-10T10:31:00Z",
        "duration_ms": 30500
      }
    ]
  }
}
```
```

**新規ファイル: `.claude/hooks/post-review.sh`**:
```bash
#!/bin/bash
# レビュー完了後の自動保存フック

REVIEW_OUTPUT_DIR="ai/reviews"
METRICS_OUTPUT_DIR="ai/review-metrics"

# ディレクトリ存在確認
mkdir -p "$REVIEW_OUTPUT_DIR"
mkdir -p "$METRICS_OUTPUT_DIR"

# 最新のレビュー結果をタイムスタンプ付きでバックアップ
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
echo "Review completed at $TIMESTAMP"
echo "Results saved to $REVIEW_OUTPUT_DIR"
echo "Metrics saved to $METRICS_OUTPUT_DIR"
```

### Phase 4: 品質検証強化
**目標**: 自己検証プロセスを強化し、レビュー品質を確保

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-013 | 自己検証チェックリストを詳細化 | `.claude/agents/pr-reviewer.md` | 5項目以上が具体的に定義される | [ ] |
| TASK-014 | エビデンス付与率の目標値を明記 | `.claude/agents/pr-reviewer.md` | 80%以上が目標として明記される | [ ] |

### Phase 5: テストと検証
**目標**: 改善後のレビュー精度を検証

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-015 | `/review` コマンドの動作確認 | - | コマンドが正常に動作する | [ ] |
| TASK-016 | Quick Review のテスト実行 | - | 小規模PRでレビューが完了する | [ ] |
| TASK-017 | Standard Review のテスト実行 | - | 中規模PRでレビューが完了する | [ ] |
| TASK-018 | Deep Review のテスト実行 | - | 大規模PRでレビューが完了する | [ ] |
| TASK-019 | 計測データの出力確認 | - | JSONが正しく出力される（errorsスキーマ含む） | [ ] |
| TASK-020 | フォールバック動作確認 | - | MCP失敗時にフォールバックが動作する | [ ] |
| TASK-021 | フック実行確認 | - | レビュー完了後にpost-review.shが実行される | [ ] |

## 5. テスト計画

| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-001 | 単体 | `/review` コマンド認識確認 | `claude /help` でコマンドがリストに表示される |
| TEST-002 | 単体 | PR番号引数の解析 | `/review #123` でPR情報がGitHub MCPから取得される |
| TEST-003 | 統合 | Quick Review 完走 | 5分以内にレビュー完了、計測データ出力 |
| TEST-004 | 統合 | Standard Review 完走 | 15分以内にレビュー完了、計測データ出力 |
| TEST-005 | 統合 | 計測データ出力 | JSONファイルが正しく生成される（errorsスキーマ含む） |
| TEST-006 | 統合 | エラーハンドリング（Serena） | Serena MCP失敗時にRead/Grepにフォールバック |
| TEST-007 | 統合 | Deep Review 完走 | 30分以内にレビュー完了、計測データ出力 |
| TEST-008 | 統合 | エラーハンドリング（GitHub） | GitHub MCP失敗時にgh CLIにフォールバック |
| TEST-009 | 統合 | エラーハンドリング（msdocs/context7） | MCP失敗時に一般ベストプラクティスにフォールバック |
| TEST-010 | 統合 | フック実行確認 | レビュー完了後にpost-review.shが実行される |

## 6. 成功基準

- [ ] `/review` コマンドでPRレビューを開始できる（`claude /help`で表示確認）
- [ ] エラーハンドリング・フォールバック戦略が定義されている
- [ ] Serena MCP の詳細な活用ガイドラインが追加されている
- [ ] エビデンスベースのフィードバック例が含まれている（カテゴリ別5例）
- [ ] 計測データがJSON形式で出力される（errorsスキーマ含む）
- [ ] レビュー時間目標（Quick: 5分、Standard: 15分、Deep: 30分）を達成できる
- [ ] エビデンス付与率80%以上を達成できる
- [ ] post-review.sh フックがレビュー完了後に実行される
- [ ] `ai/review-metrics/` にJSONファイルが保存される

## 7. リスクと対策

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| RISK-001 | MCP接続が不安定 | 中 | 中 | フォールバック戦略を実装 |
| RISK-002 | レビュー時間が長くなる | 中 | 中 | ワークフロー選択で適切な深度を適用 |
| RISK-003 | エビデンス取得が困難 | 低 | 中 | 一般的なベストプラクティスにフォールバック |
| RISK-004 | フックが実行されない | 低 | 低 | フック設定の検証手順を明記 |

## 8. 依存関係

- GitHub MCP Server の正常動作
- Serena MCP の正常動作
- context7/msdocs MCP の正常動作
- Claude Code CLI のエージェント機能
- Claude Code CLI のフック機能

## 9. 期待される効果

### Before（現状）
- エージェント定義が簡潔で詳細なガイダンスが不足
- スラッシュコマンドなし（エージェント呼び出しが複雑）
- エラー時の対応が未定義
- 計測データの出力先が未整備

### After（改善後）
- `/review #123` で簡単にレビュー開始
- エラー時も継続してレビュー可能
- 計測データで品質を可視化
- エビデンスベースの具体的なフィードバック
- フックによる自動化

## 10. 次のアクション

1. [ ] Phase 1: `/review` コマンドを作成
2. [ ] Phase 2: pr-reviewer.md にエラーハンドリングを追加
3. [ ] Phase 3: 計測データディレクトリとフックを作成
4. [ ] Phase 4: 自己検証プロセスを強化
5. [ ] Phase 5: テスト実行と検証

---
*このプランは Plan Creator エージェントによって作成されました*
*2025-12-10: レビュー指摘を反映して更新*
