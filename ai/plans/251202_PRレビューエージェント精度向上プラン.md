# Pull Request レビューエージェント 精度向上プラン

**作成日**: 2024-12-02  
**更新日**: 2025-12-02  
**ステータス**: Ready for Implementation  
**エージェント**: PlanCreator  
**レビュー**: ✅ 完全承認（v2レビュー指摘反映済み）

---

## 📋 概要

### 目的
PullRequestReviewerエージェントのレビュー精度を向上させ、より実用的で建設的なコードレビューを提供する。

### スコープ
- ✅ コンテキスト理解の深化（Serena MCP活用）
- ✅ ベストプラクティスの動的参照（msdocs/context7活用）
- ✅ プロジェクト固有コンテキストの活用
- ✅ 段階的レビュープロセスの導入
- ✅ エビデンスベースのフィードバック強化

### 対象外
- ❌ GitHub上でのレビュー自動承認機能
- ❌ CI/CDパイプラインとの統合
- ❌ レビューコメントの自動投稿（手動確認を推奨）

---

## 📊 要件と制約

| カテゴリ | 内容 |
|---------|------|
| **機能要件** | Serena MCPによるシンボル単位の分析、ドキュメントMCPによるベストプラクティス参照、プロジェクトメモリの活用 |
| **非機能要件** | レビュー時間の増加は30%以内、並列処理による効率化、段階的プロセスの明確化 |
| **技術制約** | 既存のツール構成を維持、読み取り専用操作のみ、Serena MCPとドキュメントMCPが利用可能であること |
| **ガイドライン** | PlanCreatorエージェントのパターンを参考、Google Code Review ガイドラインに準拠、建設的なフィードバック |

---

## 🎯 成功基準

- [ ] レビュー精度の向上: より具体的で実行可能な指摘
- [ ] コンテキスト理解: シンボル依存関係を考慮したレビュー
- [ ] ベストプラクティス: フレームワーク固有の推奨事項を提供
- [ ] 一貫性: プロジェクト固有ルールの適用
- [ ] エビデンス: 各指摘に具体的な根拠を提示
- [ ] 効率性: レビュー時間の増加を最小限に抑制

---

## 🚀 実装ステップ

### Phase 1: コンテキスト理解の深化

| ステップ | 説明 | 完了条件 |
|---------|------|----------|
| **1.0 PRテンプレート検証** | PRテンプレート（`.github/PULL_REQUEST_TEMPLATE.md`）の必須項目（変更概要、テスト結果、検証環境、想定レビュー観点）が入力されているか確認 | テンプレート項目の充足率を判定（未入力時はフォールバック適用） |
| **1.1 Serena MCP統合** | ファイル内容確認前に`get_symbols_overview`でシンボル構造を把握 | シンボルツリーが取得できる |
| **1.2 依存関係追跡** | `find_referencing_symbols`で変更の影響範囲を分析 | 依存関係が可視化される |
| **1.3 パターン検出** | `search_for_pattern`で類似実装パターンを検索 | 既存パターンとの一貫性を評価できる |

### Phase 2: ベストプラクティスの動的参照

| ステップ | 説明 | 完了条件 |
|---------|------|---------|
| **2.1 フレームワーク検出** | PRの変更ファイルから使用フレームワークを特定 | 使用技術スタックが識別される |
| **2.2 msdocs検索** | Microsoft関連技術の公式ベストプラクティスを取得 | 該当する公式ドキュメントが参照される |
| **2.3 context7検索** | コード例とスニペットを検索して推奨パターンを特定 | 具体的なコード例が取得される |
| **2.4 フィードバック統合** | 取得したベストプラクティスをレビューコメントに組み込む | URLと具体例付きの指摘が生成される |

### Phase 3: プロジェクト固有コンテキストの活用

| ステップ | 説明 | 完了条件 |
|---------|------|----------|
| **3.1 メモリ読み込み** | `.serena/memories`から既存のプロジェクトガイドラインを取得 | プロジェクト方針が把握される |
| **3.2 CODEOWNERS確認** | 変更箇所の責任者とドメイン知識を把握 | 適切なレビュー観点が選択される |
| **3.3 追加レビュアー推薦** | CODEOWNERS外の観点（直近コミット履歴、専門タグ、類似PR担当者）から第二レビュアー候補を提示 | ドメイン外知見を拡散するレビュアー候補リストが生成される |
| **3.4 既存プラン参照** | `ai/plans`の既存プランから設計意図を理解 | アーキテクチャ整合性を評価できる |

### Phase 4: 段階的レビュープロセスの導入

| ステップ | 説明 | 完了条件 |
|---------|------|----------|
| **4.1 初期分析フェーズ** | PR情報、変更ファイル、コミット履歴を並列取得 | ✅ PR情報取得済み<br>✅ 変更ファイル一覧取得済み<br>✅ コミット履歴取得済み |
| **4.2 詳細分析フェーズ** | Serena MCPでシンボル分析、MCPでベストプラクティス取得 | ✅ 変更シンボルの100%を分析<br>✅ 少なくとも1件のベストプラクティス参照を取得<br>✅ プロジェクトメモリから関連情報を取得 |
| **4.3 統合評価フェーズ** | 収集した情報を統合し、6つの観点で評価 | ✅ 6つの観点すべてを評価<br>✅ 構造化されたレビュー結果を生成<br>✅ エビデンス付き指摘を含む |
| **4.4 品質検証フェーズ** | 自己検証チェックリストで結果を確認 | ✅ 完全性・具体性・建設性・証拠・優先度の5項目をクリア |
| **4.5 計測データ出力フェーズ** | レビュー結果を構造化フォーマット(JSON)で`ai/review-metrics/`へ保存し、週次集計に備える | ✅ レビュー結果JSONが保存される<br>✅ エビデンス付き指摘率が算出可能 |

### Phase 5: エージェント定義ファイルの更新

| ステップ | 説明 | 完了条件 |
|---------|------|---------|
| **5.1 プロセスセクション更新** | 段階的レビュープロセスを明確に記述 | 各フェーズの目的と手順が明確 |
| **5.2 ツール活用ガイド追加** | Serena MCP、msdocs、context7の使用方法を記載 | 具体的な使用例が提示される |
| **5.3 出力フォーマット拡張** | エビデンスセクションを追加（参照URL、コード例） | 新フォーマットが定義される |
| **5.4 検証プロセス強化** | 自己検証項目を具体化 | チェック項目が測定可能 |

---

## 📁 成果物

### 更新ファイル
- `pull-request-reviewer.agent.md`: 改善されたエージェント定義

### 新規追加ファイル/ディレクトリ
- `ai/review-metrics/`: レビュー計測データ保存先
- `ai/review-metrics/README.md`: 計測データフォーマット仕様
- `.github/PULL_REQUEST_TEMPLATE.md`: PRテンプレート（未存在の場合）

### 新規追加セクション
1. **段階的レビュープロセス**: 5フェーズの詳細手順（計測フェーズ追加）
2. **MCP活用ガイドライン**: Serena、msdocs、context7の使用例
3. **エビデンスベースのフィードバック**: 参照情報の提示方法
4. **プロジェクトコンテキスト参照**: メモリとCODEOWNERSの活用
5. **計測プロセス**: レビュー品質指標の収集と集計方法

---

## ⏱️ 実装スケジュール

| Phase | 所要時間 | 依存関係 |
|-------|---------|----------|
| Phase 1 | 1-2時間 | なし |
| Phase 2-3 | 1-2時間 | Phase 1完了（**並列実行可能**） |
| Phase 4 | 1-1.5時間 | Phase 1-3完了 |
| Phase 5 | 1-2時間 | Phase 1-4完了 |

**合計所要時間**: 3.5-7時間（並列実行により1時間短縮）

**注**: Phase 2（ベストプラクティス参照）とPhase 3（プロジェクトコンテキスト）は独立しており、並列実行することで効率化できます。

---

## 🚨 リスク分析と対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|--------|---------|------|
| **Serena MCPの応答時間** | 中 | 中 | 並列実行で最小化、タイムアウト設定（30秒） |
| **ベストプラクティス検索の空振り** | 低 | 中 | フォールバック：一般的なガイドライン適用 |
| **プロジェクトメモリ未整備** | 中 | 高 | 初回実行時はスキップ可能、段階的に構築 |
| **レビュー時間の超過（30%以上）** | 中 | 中 | Quick Reviewは従来通り、Deep Reviewのみ拡張機能適用 |
| **MCP接続エラー** | 高 | 低 | フォールバック処理を実装、エラー時は基本レビュー |

### フォールバック戦略

#### Phase 1（コンテキスト理解）のフォールバック
- PRテンプレート未入力時 → PR説明文とコミットメッセージから変更概要を推測、レビュー結果に「PRテンプレート未入力」警告を付与
- `get_symbols_overview`失敗時 → ファイル全体を`read`で読み取り
- `find_referencing_symbols`失敗時 → `usages`ツールで代替
- `search_for_pattern`失敗時 → 手動パターン分析（既存レビュー観点を適用）

#### Phase 2（ベストプラクティス参照）のフォールバック
- `msdocs`/`context7`検索失敗時 → 一般的なベストプラクティス適用
- 技術スタック特定失敗時 → ファイル拡張子ベースの基本レビュー

#### Phase 3（プロジェクトコンテキスト）のフォールバック
- メモリ未整備時 → スキップして次のフェーズへ進む
- `CODEOWNERS`未存在時 → 全観点を均等に適用

---

## 📈 段階的ロールアウト

### PR規模判定基準

| 規模 | 変更ファイル数 | 差分行数 | 適用ワークフロー |
|------|--------------|---------|----------------|
| **小規模** | 1-5ファイル | 〜200行 | Quick Review |
| **中規模** | 6-20ファイル | 201-800行 | Standard Review |
| **大規模** | 21ファイル以上 | 801行以上 | Deep Review |

### ステージ1: 検証フェーズ（1週間）
- **実装範囲**: Phase 1のみ
- **テスト対象**: 小規模PR（変更ファイル1-5、差分〜200行）
- **検証項目**: 
  - Serena MCP統合の安定性
  - レビュー時間の増加率
  - シンボル分析の精度
- **成功基準**: レビュー時間が30%以内の増加、エラー率5%以下
- **計測方法**: `ai/review-metrics/`に保存されたJSONから自動集計

### ステージ2: 拡張フェーズ（2週間）
- **実装範囲**: Phase 2-3を追加
- **テスト対象**: 中規模PR（変更ファイル6-20、差分201-800行）
- **検証項目**:
  - ベストプラクティス参照の有効性
  - プロジェクトコンテキストの適用率
  - フィードバックの品質向上
- **成功基準**: 指摘の80%以上にエビデンスが含まれる
- **計測方法**: レビュー結果JSONの`evidence_ratio`フィールドを週次集計

### ステージ3: 統合フェーズ（継続）
- **実装範囲**: Phase 4-5を完了
- **適用範囲**: 全ワークフロー（Quick/Standard/Deep）
- **検証項目**:
  - 全体的なレビュー品質
  - ユーザーフィードバック
  - パフォーマンス最適化
- **成功基準**: レビュー精度の主観評価で80%以上の満足度
- **計測方法**: 月次サマリーレポートを`ai/review-metrics/monthly/`に出力

---

## 🔍 詳細設計

### Serena MCP活用パターン

```markdown
## レビュープロセス（Deep Review例）

### 初期分析フェーズ
1. PR情報と変更ファイル一覧を並列取得
2. コミット履歴を取得
3. 変更ファイル数とPRタイプを判定

### 詳細分析フェーズ
1. **変更ファイルの特定**
   - PR情報から変更ファイル一覧を取得
   - ファイル拡張子から技術スタックを判定（例: `.ts` → TypeScript）

2. **並列情報収集**（以下を同時実行）
   - **シンボル構造の把握**: 各変更ファイルに対して`get_symbols_overview`を実行
   - **ベストプラクティス検索**: `msdocs`/`context7`で技術スタック別のベストプラクティスを検索
   - **プロジェクトメモリ取得**: `.serena/memories`から関連情報を読み込み

3. **依存関係の分析**
   - `find_referencing_symbols`で各変更シンボルの参照元を検索
   - 影響範囲を評価（何ファイルに影響するか）

4. **既存パターンの検索**
   - `search_for_pattern`で類似実装を検索
   - プロジェクト内の一貫性を評価

5. **コンテキストの統合**
   - 収集した全情報を統合
   - `CODEOWNERS`で責任者を確認
```

### MCPツール使用例

```markdown
## ベストプラクティス参照の流れ

1. **技術スタック特定**
   - ファイル拡張子、import文、package.jsonから判定
   - 例: `.ts`ファイル → TypeScript、React import → React

2. **msdocs検索（Microsoft技術の場合）**
   ```
   msdocs/microsoft_docs_search
   query: "TypeScript best practices error handling"
   ```

3. **context7検索（コード例）**
   ```
   context7/get-library-docs
   context7CompatibleLibraryID: "/microsoft/TypeScript"
   topic: "error handling patterns"
   ```

4. **結果の統合**
   - 取得したURLとコード例をレビューコメントに含める
   - 「このエラーハンドリングパターンは[公式ドキュメント](URL)で推奨されています」
```

### 出力フォーマット拡張

```markdown
## 詳細版レビュー結果（拡張版）

### 🔴 重要度: 高（必須対応）
1. **[src/utils/api.ts:45-60] エラーハンドリングの改善**
   
   **問題**:
   非同期エラーが適切にキャッチされていません。
   
   **推奨**:
   try-catch-finallyパターンを使用してください。
   
   **エビデンス**:
   - [TypeScript公式: Error Handling](https://www.typescriptlang.org/docs/handbook/...)
   - 類似実装: `src/utils/database.ts:120-135`
   
   **コード例**:
   ```typescript
   async function fetchData() {
     try {
       const result = await api.get('/data');
       return result;
     } catch (error) {
       logger.error('Failed to fetch data', error);
       throw new ApiError('Data fetch failed', error);
     } finally {
       // cleanup if needed
     }
   }
   ```
   
   **影響範囲**:
   - 直接参照: 3ファイル（`api-client.ts`, `data-service.ts`, `index.ts`）
   - 間接参照: 5ファイル
```

---

## 🎯 品質検証

### 実装完了チェックリスト

#### Phase 1: コンテキスト理解
- [ ] `get_symbols_overview`が各変更ファイルで実行される
- [ ] `find_referencing_symbols`で影響範囲が分析される
- [ ] `search_for_pattern`で既存パターンが検索される

#### Phase 2: ベストプラクティス参照
- [ ] 使用技術スタックが正しく特定される
- [ ] `msdocs`検索が適切なクエリで実行される
- [ ] `context7`検索で具体的なコード例が取得される
- [ ] レビューコメントにURLと例が含まれる

#### Phase 3: プロジェクトコンテキスト
- [ ] `.serena/memories`から関連情報が取得される
- [ ] `CODEOWNERS`が参照される
- [ ] プロジェクト固有ルールが適用される

#### Phase 4: 段階的プロセス
- [ ] 4つのフェーズが明確に分離されている
- [ ] 各フェーズの完了条件が明確
- [ ] フェーズ間の情報引き継ぎが適切

#### Phase 5: ドキュメント
- [ ] すべてのセクションが更新されている
- [ ] 具体的な使用例が記載されている
- [ ] 新しい出力フォーマットが定義されている

---

## 📈 期待される効果

### レビュー精度の向上
- **Before**: 表面的なコード品質チェック
- **After**: シンボル依存関係を考慮した深い分析

### フィードバックの具体性
- **Before**: 「エラーハンドリングを改善してください」
- **After**: 公式ドキュメント、コード例、影響範囲を含む具体的な提案

### プロジェクト一貫性
- **Before**: 一般的なベストプラクティスのみ
- **After**: プロジェクト固有のパターンとガイドラインを適用

### エビデンスの強化
- **Before**: レビュアーの主観的な意見
- **After**: 公式ドキュメントとコード例に基づく客観的なフィードバック

---

## 🔄 次のアクション

### 即時実行
1. [x] このプランをレビュー（完了: レビュー結果を`ai/reviews`に保存）
2. [x] 必須修正（1-4）をプランに反映（完了）
3. [ ] Phase 1の実装を開始

### 実装フェーズ（段階的ロールアウト）
1. [ ] ステージ1（Phase 1のみ）を実装（1週間）
2. [ ] 小規模PRでテスト実行
3. [ ] フィードバック収集と調整
4. [ ] ステージ2（Phase 2-3追加）実装（2週間）
5. [ ] ステージ3（Phase 4-5完了）実装（継続）

### 長期的改善
1. [ ] レビュー履歴の蓄積と分析
2. [ ] プロジェクト固有ルールの洗練
3. [ ] 新しいMCPツールの統合検討
4. [ ] 学習機能の追加（Phase 6として将来検討）

---

## 📚 参考資料

### ベストプラクティス
- [Google Engineering Practices: Code Review](https://google.github.io/eng-practices/review/reviewer/)
- [GitHub: About Pull Request Reviews](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/reviewing-changes-in-pull-requests/about-pull-request-reviews)

### 参照エージェント
- `plan-creater.agent.md`: 段階的プロセス、MCP活用パターン
- 現在の`pull-request-reviewer.agent.md`: 既存のワークフローと観点

### MCPドキュメント
- Serena MCP: シンボル分析とコード理解
- msdocs MCP: Microsoft公式ドキュメント検索
- context7 MCP: コード例とスニペット検索

---

## 📏 計測データフォーマット

### レビュー結果JSON仕様

レビュー実行後、以下のフォーマットで`ai/review-metrics/`へ保存:

```json
{
  "pr_number": 123,
  "review_date": "2025-12-02T10:30:00Z",
  "pr_size": "small",
  "changed_files": 3,
  "diff_lines": 150,
  "workflow": "quick",
  "review_duration_sec": 180,
  "findings": [
    {
      "severity": "high",
      "category": "error_handling",
      "has_evidence": true,
      "evidence_url": "https://...",
      "has_code_example": true
    }
  ],
  "metrics": {
    "total_findings": 5,
    "findings_with_evidence": 4,
    "evidence_ratio": 0.80,
    "mcp_calls": {
      "serena": 3,
      "msdocs": 1,
      "context7": 2
    },
    "errors": []
  }
}
```

### 週次集計スクリプト（疑似コード）

```bash
# ai/review-metrics/ 配下のJSONを週次で集計
find ai/review-metrics/*.json -mtime -7 | xargs jq -s '
  {
    total_reviews: length,
    avg_evidence_ratio: (map(.metrics.evidence_ratio) | add / length),
    error_rate: (map(.metrics.errors | length) | add) / length,
    avg_duration_sec: (map(.review_duration_sec) | add / length)
  }
'
```

---

**プラン作成者**: PlanCreator  
**レビュアー**: GitHub Copilot (PlanCreatorモード)  
**ステータス**: ✅ 完全承認（実装準備完了）  
**レビュー結果**: 
- v1: `ai/reviews/251202_PRレビューエージェント精度向上プラン_レビュー.md`
- v2: `ai/reviews/251202_PRレビューエージェント精度向上プラン_レビュー_v2.md`
**次のステップ**: 実装エージェント（agent モード）へのハンドオフ準備完了
