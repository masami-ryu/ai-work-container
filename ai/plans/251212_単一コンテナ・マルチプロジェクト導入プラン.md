# 単一コンテナ・マルチプロジェクト環境構築プラン

作成日: 2025年12月12日
更新日: 2025年12月13日（レビュー指摘反映v5）
作成者: Plan Creator エージェント
ステータス: Draft

## 変更履歴
| 日付 | 内容 |
|------|------|
| 2025-12-12 | 初版作成 |
| 2025-12-12 | レビュー指摘反映: バックアップ手順、ボリューム命名規則、冪等性、運用手順、テスト強化 |
| 2025-12-13 | レビュー指摘反映v2: バックアップ範囲拡大、動的ボリューム適用手順明確化、anyenv+nodenv前提化、テスト定量化 |
| 2025-12-13 | レビュー指摘反映v3: sed挿入先修正、ロールバック手順包括化、anyenv+nodenv前提条件明記 |
| 2025-12-13 | レビュー指摘反映v4: 新規スクリプトのバックアップ・復元を追加（init-project.sh、setup-project-links.sh） |
| 2025-12-13 | レビュー指摘反映v5: ボリューム抽出パターン改善、sed代替案追加、ボリューム復元手順追加、性能測定条件具体化、スクリプト配置タスク追加 |

## 1. 概要

### 目的
単一のDevContainerで複数のプロジェクトを管理し、各プロジェクトを別々のVS Codeウィンドウで開発できる環境を構築する。共通設定（`.claude/`、`.github/`等）を継承しながら、効率的なマルチプロジェクト開発ワークフローを実現する。

### スコープ
- 対象: devcontainer設定、docker-compose設定、ディレクトリ構造、セットアップスクリプト
- 対象外: 個別プロジェクトのアプリケーションコード、CI/CDパイプライン

### 前提条件
- Docker Desktop または Docker Engine がインストール済み
- VS Code と Dev Containers 拡張機能がインストール済み
- 現在のdevcontainer環境が正常に動作していること
- anyenv + nodenv が既にインストール済み（`post-create.sh`で導入済み）

## 2. 要件と制約

| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | `repo/`配下に複数プロジェクトを動的に追加できること | 高 |
| REQ-002 | 要件 | 各プロジェクトを別々のVS Codeウィンドウで開けること | 高 |
| REQ-003 | 要件 | 単一コンテナを全プロジェクトで共有すること | 高 |
| REQ-004 | 要件 | 各プロジェクトのnode_modulesを名前付きボリュームで高速化（命名規則: `${project-name}-node_modules`） | 中 |
| REQ-005 | 要件 | 共通設定（`.claude/`、`.github/`）を各プロジェクトで利用可能 | 高 |
| REQ-006 | 要件 | Claude認証・MCP設定を一度の設定で全プロジェクトに適用 | 高 |
| REQ-007 | 要件 | 既存環境へのロールバックが可能であること | 高 |
| CON-001 | 制約 | VS Codeは1ウィンドウにつき1つのworkspaceFolder | - |
| CON-002 | 制約 | 既存の環境との互換性を維持 | - |
| GUD-001 | ガイドライン | プロジェクト追加は`git clone`で行う | - |

## 3. アーキテクチャ設計

### ディレクトリ構造（目標）
```
ai-work-container/
├── .devcontainer/
│   ├── devcontainer.json      # メイン設定（docker-compose参照）
│   ├── docker-compose.yml     # 単一サービス定義
│   ├── Dockerfile
│   ├── init-project.sh        # プロジェクト初期化スクリプト
│   ├── setup-project-links.sh # 共通設定リンク作成
│   ├── backup/                # バックアップ保存先
│   │   └── .gitkeep
│   └── ...
├── .claude/                    # 共通Claude設定
├── .github/                    # 共通GitHub設定
├── repo/                       # プロジェクト格納ディレクトリ
│   ├── project-a/
│   │   ├── .devcontainer/
│   │   │   └── devcontainer.json  # 親コンテナにattach
│   │   └── ...
│   ├── project-b/
│   │   ├── .devcontainer/
│   │   │   └── devcontainer.json
│   │   └── ...
│   └── .gitkeep
└── ...
```

### コンテナ共有モデル
```
┌─────────────────────────────────────────────────────────┐
│                  Docker Container                        │
│  (ai-work-container)                                    │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  VS Code     │  │  VS Code     │  │  VS Code     │  │
│  │  Window 1    │  │  Window 2    │  │  Window 3    │  │
│  │  (main)      │  │  (project-a) │  │  (project-b) │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                          │
│  /workspaces/ai-work-container/                         │
│    ├── repo/project-a/  ← workspaceFolder               │
│    ├── repo/project-b/  ← workspaceFolder               │
│    └── ...                                              │
│                                                          │
│  ~/.config/claude-code/  ← 認証・設定（共有）            │
│  ~/.claude.json          ← MCP設定（共有）               │
└─────────────────────────────────────────────────────────┘
```

## 4. 実装ステップ

### Phase 1: 基盤整備（バックアップ含む）
**目標**: Docker Composeベースのdevcontainer環境を構築（ロールバック可能）

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-000 | anyenv+nodenv導入状況の確認 | - | `nodenv --version`が成功する | [ ] |
| TASK-001-A | バックアップスクリプトの作成 | `.devcontainer/backup-devcontainer.sh` | スクリプトが実行可能（chmod +x済み） | [ ] |
| TASK-001-B | ロールバックスクリプトの作成 | `.devcontainer/rollback-devcontainer.sh` | スクリプトが実行可能（chmod +x済み） | [ ] |
| TASK-001 | 既存devcontainer設定のバックアップ実行 | `.devcontainer/backup/` | `devcontainer.json.bak`、全スクリプト（post-create.sh、init-project.sh等）のバックアップが存在する | [ ] |
| TASK-002 | 既存Dockerボリューム一覧の記録 | `.devcontainer/backup/volumes.txt` | ボリューム一覧が記録されている | [ ] |
| TASK-003 | repo/ディレクトリを作成 | `repo/.gitkeep` | ディレクトリが存在する | [ ] |
| TASK-004 | docker-compose.ymlを作成 | `.devcontainer/docker-compose.yml` | 単一サービスが定義されている | [ ] |
| TASK-005 | devcontainer.jsonをdocker-compose対応に更新 | `.devcontainer/devcontainer.json` | docker-composeを参照している | [ ] |
| TASK-006 | 既存環境の動作確認 | - | コンテナが正常に起動する | [ ] |
| TASK-007 | ロールバック手順の検証 | - | バックアップから復旧できる | [ ] |

### Phase 2: プロジェクトテンプレート作成
**目標**: 子プロジェクト用のdevcontainer設定テンプレートを作成

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-008 | 子プロジェクト用devcontainer.jsonテンプレート作成 | `ai/templates/project-devcontainer.json` | テンプレートが存在する | [ ] |
| TASK-009 | プロジェクト初期化スクリプト作成（冪等性対応） | `.devcontainer/init-project.sh` | スクリプトが実行可能、再実行で既存をスキップ | [ ] |
| TASK-010 | node_modules用ボリューム設定追加（命名規則適用） | `.devcontainer/docker-compose.yml` | `${project}-node_modules`形式で定義 | [ ] |

### Phase 3: 共通設定の継承設定
**目標**: 各プロジェクトで共通設定を利用できるようにする

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-011 | 共通設定のシンボリックリンク作成スクリプト（冪等性対応） | `.devcontainer/setup-project-links.sh` | 既存リンク検知・スキップ機能あり | [ ] |
| TASK-012 | プロジェクト用CLAUDE.mdテンプレート作成 | `ai/templates/project-CLAUDE.md` | テンプレートが存在する | [ ] |
| TASK-013 | postCreateCommandの更新 | `.devcontainer/post-create.sh` | init-project.sh呼び出しなし（手動実行） | [ ] |
| TASK-014 | init-project.shからsetup-project-links.sh呼び出し | `.devcontainer/init-project.sh` | リンク作成が自動実行される | [ ] |

### Phase 4: ドキュメント・検証
**目標**: セットアップ手順のドキュメント化と動作検証

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-015 | マルチプロジェクト運用ガイド作成（具体的操作手順含む） | `docs/multi-project-setup.md` | VS Codeコマンド・CLI手順が記載 | [ ] |
| TASK-016 | サンプルプロジェクトで検証 | `repo/sample-project/` | 別ウィンドウで開ける | [ ] |
| TASK-017 | CLAUDE.mdにマルチプロジェクト情報追加 | `CLAUDE.md` | 情報が追記されている | [ ] |
| TASK-018 | ボリュームクリーンアップ手順の文書化 | `docs/multi-project-setup.md` | 不要ボリューム削除手順が記載 | [ ] |

## 5. 詳細設計

### 5.1 バックアップ・復旧手順

#### バックアップ実行（TASK-001, TASK-002）
```bash
#!/bin/bash
# backup-devcontainer.sh
BACKUP_DIR=".devcontainer/backup"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# devcontainer設定ファイルのバックアップ
cp .devcontainer/devcontainer.json "$BACKUP_DIR/devcontainer.json.${TIMESTAMP}.bak"
cp .devcontainer/docker-compose.yml "$BACKUP_DIR/docker-compose.yml.${TIMESTAMP}.bak" 2>/dev/null || echo "[INFO] docker-compose.yml not found (OK if not migrated yet)"

# スクリプト類のバックアップ
cp .devcontainer/post-create.sh "$BACKUP_DIR/post-create.sh.${TIMESTAMP}.bak" 2>/dev/null || true
cp .devcontainer/Dockerfile "$BACKUP_DIR/Dockerfile.${TIMESTAMP}.bak" 2>/dev/null || true

# 新規追加スクリプトのバックアップ（マルチプロジェクト環境に必須）
cp .devcontainer/init-project.sh "$BACKUP_DIR/init-project.sh.${TIMESTAMP}.bak" 2>/dev/null || echo "[INFO] init-project.sh not found (OK if not created yet)"
cp .devcontainer/setup-project-links.sh "$BACKUP_DIR/setup-project-links.sh.${TIMESTAMP}.bak" 2>/dev/null || echo "[INFO] setup-project-links.sh not found (OK if not created yet)"

# Dockerボリューム一覧の記録（全プロジェクト関連ボリュームを取得）
# ai-work-container プレフィックス、-node_modules サフィックス、claude- プレフィックスの全パターンを取得
docker volume ls --format '{{.Name}}' | grep -E "(^ai-work-container|-node_modules$|^claude-)" > "$BACKUP_DIR/volumes.${TIMESTAMP}.txt"

echo "Backup completed: $BACKUP_DIR"
echo "Files backed up:"
ls -lh "$BACKUP_DIR"/*${TIMESTAMP}*
```

#### ロールバック手順
```bash
#!/bin/bash
# rollback-devcontainer.sh
# 使用方法: ./rollback-devcontainer.sh <TIMESTAMP>
# 例: ./rollback-devcontainer.sh 20251212_120000

TIMESTAMP="$1"
BACKUP_DIR=".devcontainer/backup"

if [ -z "$TIMESTAMP" ]; then
    echo "Usage: $0 <TIMESTAMP>"
    echo "Available backups:"
    ls -1 "$BACKUP_DIR"/*.bak 2>/dev/null | sed 's/.*\.\([0-9_]*\)\.bak/\1/' | sort -u
    exit 1
fi

echo "Rolling back to backup: $TIMESTAMP"

# devcontainer.json の復元
if [ -f "$BACKUP_DIR/devcontainer.json.${TIMESTAMP}.bak" ]; then
    cp "$BACKUP_DIR/devcontainer.json.${TIMESTAMP}.bak" .devcontainer/devcontainer.json
    echo "[OK] devcontainer.json restored"
else
    echo "[WARN] devcontainer.json.${TIMESTAMP}.bak not found"
fi

# docker-compose.yml の復元
if [ -f "$BACKUP_DIR/docker-compose.yml.${TIMESTAMP}.bak" ]; then
    cp "$BACKUP_DIR/docker-compose.yml.${TIMESTAMP}.bak" .devcontainer/docker-compose.yml
    echo "[OK] docker-compose.yml restored"
else
    echo "[WARN] docker-compose.yml.${TIMESTAMP}.bak not found (may not have existed yet)"
fi

# post-create.sh の復元（オプション）
if [ -f "$BACKUP_DIR/post-create.sh.${TIMESTAMP}.bak" ]; then
    cp "$BACKUP_DIR/post-create.sh.${TIMESTAMP}.bak" .devcontainer/post-create.sh
    echo "[OK] post-create.sh restored"
fi

# Dockerfile の復元（オプション）
if [ -f "$BACKUP_DIR/Dockerfile.${TIMESTAMP}.bak" ]; then
    cp "$BACKUP_DIR/Dockerfile.${TIMESTAMP}.bak" .devcontainer/Dockerfile
    echo "[OK] Dockerfile restored"
fi

# 新規追加スクリプトの復元（マルチプロジェクト環境に必須）
if [ -f "$BACKUP_DIR/init-project.sh.${TIMESTAMP}.bak" ]; then
    cp "$BACKUP_DIR/init-project.sh.${TIMESTAMP}.bak" .devcontainer/init-project.sh
    echo "[OK] init-project.sh restored"
else
    echo "[WARN] init-project.sh.${TIMESTAMP}.bak not found (may not have existed yet)"
fi

if [ -f "$BACKUP_DIR/setup-project-links.sh.${TIMESTAMP}.bak" ]; then
    cp "$BACKUP_DIR/setup-project-links.sh.${TIMESTAMP}.bak" .devcontainer/setup-project-links.sh
    echo "[OK] setup-project-links.sh restored"
else
    echo "[WARN] setup-project-links.sh.${TIMESTAMP}.bak not found (may not have existed yet)"
fi

echo ""
echo "Rollback completed. You must rebuild the container to apply changes:"
echo "  VS Code: Ctrl+Shift+P → 'Dev Containers: Rebuild Container'"
echo "  CLI: docker compose -f .devcontainer/docker-compose.yml down && docker compose -f .devcontainer/docker-compose.yml up -d --build"
```

#### ボリュームのバックアップ・復元手順

**注意**: Dockerボリュームのデータバックアップは、設定ファイルのバックアップとは別に行う必要があります。

##### ボリュームデータのバックアップ
```bash
#!/bin/bash
# backup-volumes.sh
# 使用方法: ./backup-volumes.sh <volume-name>

VOLUME_NAME=$1
BACKUP_DIR=".devcontainer/backup/volumes"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

if [ -z "$VOLUME_NAME" ]; then
    echo "Usage: $0 <volume-name>"
    exit 1
fi

mkdir -p "$BACKUP_DIR"

# ボリュームをtarアーカイブにエクスポート
docker run --rm \
    -v "${VOLUME_NAME}:/source:ro" \
    -v "$(pwd)/${BACKUP_DIR}:/backup" \
    ubuntu:24.04 \
    tar czf "/backup/${VOLUME_NAME}.${TIMESTAMP}.tar.gz" -C /source .

echo "Volume backed up: ${BACKUP_DIR}/${VOLUME_NAME}.${TIMESTAMP}.tar.gz"
```

##### ボリュームデータの復元
```bash
#!/bin/bash
# restore-volumes.sh
# 使用方法: ./restore-volumes.sh <volume-name> <backup-file>

VOLUME_NAME=$1
BACKUP_FILE=$2

if [ -z "$VOLUME_NAME" ] || [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <volume-name> <backup-file.tar.gz>"
    exit 1
fi

if [ ! -f "$BACKUP_FILE" ]; then
    echo "Error: Backup file not found: $BACKUP_FILE"
    exit 1
fi

# ボリュームが存在しない場合は作成
docker volume inspect "$VOLUME_NAME" >/dev/null 2>&1 || docker volume create "$VOLUME_NAME"

# tarアーカイブからボリュームにインポート
docker run --rm \
    -v "${VOLUME_NAME}:/target" \
    -v "$(pwd)/$(dirname ${BACKUP_FILE}):/backup:ro" \
    ubuntu:24.04 \
    tar xzf "/backup/$(basename ${BACKUP_FILE})" -C /target

echo "Volume restored: $VOLUME_NAME from $BACKUP_FILE"
```

**重要な注意事項**:
- ボリュームバックアップは**データ保護が必要な場合のみ**実行（node_modulesは再インストール可能なので通常は不要）
- Claude認証ボリューム（`claude-config`、`claude-json`）は必要に応じてバックアップ推奨
- 大容量ボリュームのバックアップは時間がかかるため、計画的に実施
```

### 5.2 docker-compose.yml（新規作成）
```yaml
services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # ワークスペース全体をマウント
      - ..:/workspaces/ai-work-container:cached
      # メインプロジェクトのnode_modules
      - ai-work-container-node_modules:/workspaces/ai-work-container/node_modules
      # Claude設定を永続化
      - claude-config:/home/vscode/.config/claude-code
      - claude-json:/home/vscode/.claude.json
    # コンテナを起動し続ける
    command: sleep infinity
    # ネットワーク設定
    networks:
      - dev-network

networks:
  dev-network:
    driver: bridge

volumes:
  ai-work-container-node_modules:
  claude-config:
  claude-json:
  # 追加プロジェクト用ボリュームはinit-project.shで動的に追加
  # 命名規則: ${project-name}-node_modules
```

### 5.3 ボリューム命名規則

| 種別 | 命名パターン | 例 |
|------|-------------|-----|
| メインプロジェクト | `ai-work-container-node_modules` | - |
| 子プロジェクト | `${project-name}-node_modules` | `my-app-node_modules` |
| Claude認証 | `claude-config` | - |
| Claude MCP設定 | `claude-json` | - |

**Nodeバージョン差異の方針**:
- 各プロジェクトで異なるNodeバージョンが必要な場合は、既存のanyenv+nodenv環境を使用
- プロジェクトルートに`.node-version`ファイルを配置するか、`package.json`の`engines.node`フィールドで指定
- `post-create.sh`がこれらを自動検出してnodenvで適切なバージョンをインストール・設定
- node_modulesボリュームはNodeバージョンに依存しないため、ボリューム名にバージョンを含めない

### 5.4 子プロジェクト用devcontainer.json（テンプレート）
```json
{
  "name": "Project: ${PROJECT_NAME}",
  "dockerComposeFile": [
    "../../../.devcontainer/docker-compose.yml"
  ],
  "service": "devcontainer",
  "workspaceFolder": "/workspaces/ai-work-container/repo/${PROJECT_NAME}",
  "shutdownAction": "none",
  "customizations": {
    "vscode": {
      "settings": {
        "git.autofetch": true
      }
    }
  }
}
```

### 5.5 プロジェクト初期化スクリプト（冪等性対応）
```bash
#!/bin/bash
# init-project.sh
# 使用方法: ./init-project.sh <project-name> [git-url]
# 冪等性: 既存のディレクトリ/設定がある場合はスキップ

set -e

PROJECT_NAME=$1
GIT_URL=$2
PROJECT_DIR="/workspaces/ai-work-container/repo/${PROJECT_NAME}"
DEVCONTAINER_DIR="${PROJECT_DIR}/.devcontainer"
TEMPLATE="/workspaces/ai-work-container/ai/templates/project-devcontainer.json"

# 引数チェック
if [ -z "$PROJECT_NAME" ]; then
    echo "Usage: $0 <project-name> [git-url]"
    exit 1
fi

# 1. ディレクトリ作成またはgit clone（冪等性: 既存ならスキップ）
if [ -d "$PROJECT_DIR" ]; then
    echo "[SKIP] Directory already exists: $PROJECT_DIR"
else
    if [ -n "$GIT_URL" ]; then
        echo "[CREATE] Cloning $GIT_URL to $PROJECT_DIR"
        git clone "$GIT_URL" "$PROJECT_DIR"
    else
        echo "[CREATE] Creating directory: $PROJECT_DIR"
        mkdir -p "$PROJECT_DIR"
    fi
fi

# 2. .devcontainer/devcontainer.json を生成（冪等性: 既存ならスキップ）
if [ -f "${DEVCONTAINER_DIR}/devcontainer.json" ]; then
    echo "[SKIP] devcontainer.json already exists"
else
    echo "[CREATE] Generating devcontainer.json"
    mkdir -p "$DEVCONTAINER_DIR"
    sed "s/\${PROJECT_NAME}/${PROJECT_NAME}/g" "$TEMPLATE" > "${DEVCONTAINER_DIR}/devcontainer.json"
fi

# 3. 共通設定へのシンボリックリンク作成
echo "[SETUP] Creating symbolic links for common settings"
/workspaces/ai-work-container/.devcontainer/setup-project-links.sh "$PROJECT_NAME"

# 4. node_modules用ボリューム設定をdocker-compose.ymlに追加（冪等性: 既存ならスキップ）
VOLUME_NAME="${PROJECT_NAME}-node_modules"
COMPOSE_FILE="/workspaces/ai-work-container/.devcontainer/docker-compose.yml"

if grep -q "$VOLUME_NAME" "$COMPOSE_FILE"; then
    echo "[SKIP] Volume $VOLUME_NAME already defined"
else
    echo "[CREATE] Adding volume $VOLUME_NAME to docker-compose.yml"

    # 方法1: sed（順序依存だが簡潔）
    # トップレベルvolumesセクションに追加
    sed -i "/^volumes:/a\\  ${VOLUME_NAME}:" "$COMPOSE_FILE"
    # servicesのvolumesに追加（サービス内の - claude-json: 行に限定）
    MOUNT_LINE="      - ${VOLUME_NAME}:/workspaces/ai-work-container/repo/${PROJECT_NAME}/node_modules"
    sed -i "/^[[:space:]]*-[[:space:]]*claude-json:.*\/home/a\\${MOUNT_LINE}" "$COMPOSE_FILE"

    # 方法2（より安定）: yqツールを使用（要インストール: apt-get install yq）
    # yq -i ".volumes.${VOLUME_NAME} = {}" "$COMPOSE_FILE"
    # yq -i ".services.devcontainer.volumes += [\"${VOLUME_NAME}:/workspaces/ai-work-container/repo/${PROJECT_NAME}/node_modules\"]" "$COMPOSE_FILE"

    # 注意: 方法1が失敗する場合は、手動でdocker-compose.ymlを編集するか、方法2のyqツールを使用してください
fi

echo ""
echo "=== Project initialized successfully ==="
echo ""
echo "IMPORTANT: docker-compose.yml has been updated with new volume."
echo "You must recreate the container for the volume to take effect:"
echo ""
echo "  1. Exit all VS Code windows attached to this container"
echo "  2. Rebuild the container:"
echo "     - VS Code: Ctrl+Shift+P → 'Dev Containers: Rebuild Container'"
echo "     - CLI: docker compose -f .devcontainer/docker-compose.yml up -d --build"
echo ""
echo "After rebuild, open the new project:"
echo "  1. Open VS Code Command Palette (Ctrl+Shift+P)"
echo "  2. Run: Dev Containers: Open Folder in Container..."
echo "  3. Select: /workspaces/ai-work-container/repo/${PROJECT_NAME}"
echo ""
```

### 5.6 共通設定リンク作成スクリプト（冪等性対応）
```bash
#!/bin/bash
# setup-project-links.sh
# 使用方法: ./setup-project-links.sh <project-name>
# 冪等性: 既存のシンボリックリンクがある場合はスキップ

set -e

PROJECT_NAME=$1
PROJECT_DIR="/workspaces/ai-work-container/repo/${PROJECT_NAME}"
COMMON_CLAUDE="/workspaces/ai-work-container/.claude"
COMMON_GITHUB="/workspaces/ai-work-container/.github"

if [ -z "$PROJECT_NAME" ]; then
    echo "Usage: $0 <project-name>"
    exit 1
fi

# .claudeへのシンボリックリンク（冪等性チェック）
if [ -L "${PROJECT_DIR}/.claude" ]; then
    echo "[SKIP] .claude symlink already exists"
elif [ -d "${PROJECT_DIR}/.claude" ]; then
    echo "[WARN] .claude directory exists (not a symlink). Skipping."
else
    echo "[CREATE] Creating .claude symlink"
    ln -s "$COMMON_CLAUDE" "${PROJECT_DIR}/.claude"
fi

# .githubへのシンボリックリンク（冪等性チェック）
if [ -L "${PROJECT_DIR}/.github" ]; then
    echo "[SKIP] .github symlink already exists"
elif [ -d "${PROJECT_DIR}/.github" ]; then
    echo "[WARN] .github directory exists (not a symlink). Skipping."
else
    echo "[CREATE] Creating .github symlink"
    ln -s "$COMMON_GITHUB" "${PROJECT_DIR}/.github"
fi

echo "[DONE] Symbolic links setup completed for $PROJECT_NAME"
```

### 5.7 Claude認証・MCP設定の共有
Claude Code CLIの認証情報とMCP設定は以下の場所に保存される：
- 認証: `~/.config/claude-code/`（名前付きボリューム`claude-config`で永続化）
- MCP設定: `~/.claude.json`（名前付きボリューム`claude-json`で永続化）

これらはユーザーホームディレクトリに保存されるため、同一コンテナ内のすべてのプロジェクトで自動的に共有される。

## 6. テスト計画

### 基本機能テスト
| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-001 | 統合 | メインプロジェクトでコンテナ起動 | コンテナが正常起動 |
| TEST-002 | 統合 | 子プロジェクトをgit cloneで追加 | プロジェクトが追加される |
| TEST-003 | 統合 | 子プロジェクトを別ウィンドウで開く | 同じコンテナにattach |
| TEST-004 | 統合 | 1つのウィンドウを閉じる | 他のウィンドウは動作継続 |
| TEST-005 | 単体 | claude --versionを両ウィンドウで実行 | 同じ認証情報を参照 |
| TEST-006 | 単体 | MCP設定の確認 | 両ウィンドウで同じMCP設定 |
| TEST-007 | 性能 | node_modules操作の速度（定量測定） | ベースライン環境（非ボリューム）でnpm install実行後、`rm -rf node_modules && npm cache clean --force`、ボリューム環境で再実行し50%以上短縮 |
| TEST-017 | 単体 | 動的追加ボリュームのマウント確認（docker inspect） | 追加したボリュームが正しくマウントされている |
| TEST-018 | 単体 | Nodeバージョン管理（anyenv+nodenv） | `.node-version`指定でnodenvが適切なバージョンを使用 |

### 冪等性・エッジケーステスト
| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-008 | 単体 | init-project.shを同一プロジェクトで2回実行 | 2回目は既存をスキップ、エラーなし |
| TEST-009 | 単体 | setup-project-links.shを2回実行 | 2回目は既存リンクをスキップ |
| TEST-010 | 単体 | 既存.claudeディレクトリがある状態でリンク作成 | 警告表示、スキップ、エラーなし |
| TEST-011 | 単体 | 同名ボリュームが既に存在する場合 | docker-compose.ymlへの重複追加なし |

### 互換性・ロールバックテスト
| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-012 | 統合 | バックアップからdevcontainer.jsonを復元 | 旧設定でコンテナ起動可能 |
| TEST-013 | 統合 | 移行後に既存プロジェクト（メイン）が動作 | Claude、MCP、git等が正常動作 |
| TEST-014 | 統合 | 移行後に既存ボリュームデータが保持 | node_modules等のデータ損失なし |

### ボリューム管理テスト
| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-015 | 単体 | 異なるプロジェクトで同名ボリュームを使用 | 命名規則により衝突しない |
| TEST-016 | 単体 | 不要ボリュームの削除 | ドキュメント通りに削除可能 |
| TEST-019 | 統合 | init-project.sh実行後のコンテナ再作成 | 新規ボリュームが正常にマウントされる |
| TEST-020 | 性能 | ボリュームマウント前後のnpm install速度比較 | 測定条件: 同一package.json（例: react 50+依存）で、(1)非ボリューム環境で`time npm install`実行、(2)`rm -rf node_modules && npm cache clean --force`、(3)ボリューム環境で`time npm install`実行、(3)が(1)より50%以上短縮 |

## 7. 成功基準

- [ ] repo/配下にgit cloneでプロジェクトを追加できる
- [ ] 各プロジェクトを別々のVS Codeウィンドウで開ける
- [ ] 複数ウィンドウが同一コンテナを共有している
- [ ] 1つのウィンドウを閉じても他のウィンドウは動作し続ける
- [ ] Claude認証が全プロジェクトで共有されている
- [ ] MCP設定が全プロジェクトで共有されている
- [ ] node_modulesのパフォーマンスが改善されている（定量測定で50%以上短縮）
- [ ] バックアップからロールバック可能である（docker-compose.yml、スクリプト含む）
- [ ] init-project.shは冪等性を持つ（再実行でエラーなし）
- [ ] setup-project-links.shは冪等性を持つ（再実行でエラーなし）
- [ ] init-project.sh実行後、コンテナ再作成で新規ボリュームがマウントされる
- [ ] anyenv+nodenvでプロジェクト固有のNodeバージョンが使用できる

## 8. リスクと対策

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| RISK-001 | docker-compose移行で既存環境が壊れる | 高 | 中 | TASK-001,002でバックアップ（全設定ファイル・スクリプト含む）、包括的ロールバックスクリプトで復旧検証（init-project.sh、setup-project-links.sh含む） |
| RISK-002 | 相対パスの解決が複雑になる | 中 | 中 | シンボリックリンクで絶対パスを使用 |
| RISK-003 | ボリューム増加でディスク容量不足 | 低 | 低 | TASK-018で削除手順を文書化、動的ボリュームも含めて記録 |
| RISK-004 | 子プロジェクトのdevcontainer.jsonが見つからない | 中 | 中 | init-project.shで自動生成 |
| RISK-005 | スクリプト再実行で設定が破壊される | 中 | 中 | 全スクリプトに冪等性チェックを実装 |
| RISK-006 | 共通設定リンクが既存ディレクトリと衝突 | 低 | 中 | 既存ディレクトリ検知で警告・スキップ |
| RISK-007 | 動的追加ボリュームがマウントされない | 高 | 中 | init-project.sh完了後にコンテナ再作成手順を案内、TEST-019で検証 |
| RISK-008 | 異なるNodeバージョンの競合 | 中 | 低 | anyenv+nodenvでプロジェクトごとに`.node-version`で管理、TASK-000で導入状況確認、TEST-018で検証 |
| RISK-009 | sed挿入でdocker-compose.ymlが破損 | 高 | 低 | sedパターンを厳密化（`/home`パス含むパターンでサービス側のみマッチ）、失敗時はyqツールまたは手動編集を案内 |
| RISK-010 | ボリューム復元手段が未整備 | 中 | 低 | 重要ボリューム（claude-config等）のみバックアップ手順を提供、node_modulesは再インストール可能なので不要 |

## 9. 依存関係

- Docker Desktop / Docker Engine
- VS Code Dev Containers 拡張機能
- 現在のdevcontainer環境（Dockerfile、post-create.sh等）

## 10. 運用手順（概要）

### 子プロジェクトを別ウィンドウで開く手順

**方法1: VS Code UI経由**
1. メインウィンドウで `F1` → `Dev Containers: Open Folder in Container...`
2. `/workspaces/ai-work-container/repo/${PROJECT_NAME}` を選択
3. 既存コンテナにattachして新しいウィンドウが開く

**方法2: devcontainer CLI経由**
```bash
# コンテナ内から実行
devcontainer open /workspaces/ai-work-container/repo/${PROJECT_NAME}
```

**方法3: VS Code Remote Explorer経由**
1. VS CodeのRemote Explorerパネルを開く
2. 「Dev Containers」セクションで実行中コンテナを右クリック
3. 「Attach to Container」を選択
4. 新しいウィンドウでフォルダを開く

### 初回ビルドの責任範囲
- **メインプロジェクト（ai-work-container）**: 初回ビルドを担当。docker-compose.ymlに基づきコンテナを作成
- **子プロジェクト**: 既存コンテナにattachするのみ。ビルドは行わない

詳細は `docs/multi-project-setup.md` を参照。

## 11. 参考資料

- [VS Code: Connect to multiple containers](https://code.visualstudio.com/remote/advancedcontainers/connect-multiple-containers)
- [VS Code: Attach to a running container](https://code.visualstudio.com/docs/devcontainers/attach-container)
- [Docker Compose documentation](https://docs.docker.com/compose/)
- [Microsoft Learn: Multi-container apps with Docker Compose](https://learn.microsoft.com/en-us/visualstudio/docker/tutorials/tutorial-multi-container-app-mysql)

## 12. 次のアクション

1. [ ] TASK-000でanyenv+nodenv導入状況を確認
2. [ ] TASK-001-A,Bでバックアップ・ロールバックスクリプトを作成
3. [ ] TASK-001,002を実行して既存環境をバックアップ
4. [ ] Phase 1のTASK-003〜007を実行してdocker-compose基盤を構築
5. [ ] コンテナ再ビルドで動作確認
6. [ ] TASK-007でロールバック手順を検証
7. [ ] Phase 2のテンプレート・スクリプト作成
8. [ ] Phase 3の共通設定継承を実装
9. [ ] サンプルプロジェクトで全テストを実行（性能測定条件に従う）

---
*このプランは Plan Creator エージェントによって作成されました*
*レビュー指摘を反映して更新: 2025年12月13日（v5）*

## 修正履歴（v5）
- ボリューム抽出パターンを改善（`-node_modules$`を明示的に追加）
- Phase 1にバックアップ・ロールバックスクリプト作成タスクを追加（TASK-001-A, TASK-001-B）
- ボリュームデータのバックアップ・復元手順を追加（backup-volumes.sh、restore-volumes.sh）
- sed代替案を追加（yqツールによる安定した編集方法）
- 性能測定条件を具体化（TEST-007、TEST-020にベースライン環境とキャッシュクリア手順を明記）
- RISK-010を追加（ボリューム復元手段の整備）

## 修正履歴（v4）
- バックアップスクリプトに新規スクリプトを追加（init-project.sh、setup-project-links.sh）
- ロールバックスクリプトに新規スクリプトの復元処理を追加
- TASK-001の完了条件を更新（全スクリプトのバックアップを明記）

## 修正履歴（v3）
- sed挿入先の問題を修正（`/home`パス含むパターンでサービス側のみマッチ）
- ロールバックスクリプトを包括的に修正（docker-compose.yml、スクリプト類も復元）
- anyenv+nodenv前提条件を明記、TASK-000で導入状況確認を追加
- RISK-009を追加（sed挿入でdocker-compose.ymlが破損するリスク）

## 修正履歴（v2）
- バックアップ範囲を拡大（docker-compose.yml、スクリプト、動的ボリューム対応）
- init-project.sh完了後のコンテナ再作成手順を明確化
- Nodeバージョン管理をanyenv+nodenv前提に変更（nvmの記述削除）
- テスト計画に定量的な性能測定条件を追加（50%短縮目標）
- 動的ボリュームマウント確認テストを追加（TEST-017, TEST-019, TEST-020）
- 成功基準とリスク対策を更新
