# Claude永続化設定削除プラン

作成日: 2025年12月13日
作成者: Plan Creator エージェント
ステータス: Draft

## 変更履歴
| 日付 | 内容 |
|------|------|
| 2025-12-13 | 初版作成 |
| 2025-12-13 | レビュー指摘反映: 他プラン整合性、検証範囲拡充、既存ボリューム移行手順追加 |

## 1. 概要

### 目的
Claude Code CLIの設定をボリュームマウントで永続化するとインストールに失敗する問題を解決するため、Claude設定の永続化を廃止し、コンテナ内の標準ファイルとして管理する方針に変更する。

### スコープ
- 対象: docker-compose.yml、devcontainer.json、post-create.sh、関連ドキュメント
- 対象外: MCP設定の内容変更、その他のツールチェーン

### 前提条件
- 現在のプロジェクトは単一コンテナ・マルチプロジェクト環境を採用している
- Claude Code CLIは既にインストール済み（`~/.claude.json`は通常ファイルとして存在）
- docker-compose.ymlに`claude-config`および`claude-json`ボリュームが定義されているが、現在はコメントアウトされている

### 現状分析
以下のファイルを分析した結果、以下の状況が判明しました：

1. **docker-compose.yml (.devcontainer/docker-compose.yml:11-13)**
   - `claude-config`および`claude-json`ボリュームマウントは**既にコメントアウト済み**
   - ボリューム定義自体は volumes セクションに残存（28-29行目）

2. **Claude Code CLI インストール状況**
   - `~/.claude.json`は通常ファイルとして存在（-rw-------）、4935バイト
   - `~/.config/claude-code/`ディレクトリも存在（空ディレクトリ）
   - 現在の設定でClaude Code CLIは正常に動作している

3. **post-create.sh**
   - Claude Code CLIのインストールスクリプトは冪等性を持つ（既にインストール済みの場合はスキップ）
   - ボリューム永続化に関する特別な処理は含まれていない

4. **ドキュメントへの影響**
   - 251212プランの5.7節でClaude設定永続化について言及
   - CLAUDE.mdの「マルチプロジェクト環境」セクションで共通設定について記載
   - docs/multi-project-setup.mdでClaude設定永続化について記載

## 2. 要件と制約

| ID | 種別 | 内容 | 優先度 |
|----|------|------|--------|
| REQ-001 | 要件 | Claude設定の永続化ボリュームを完全に削除すること | 高 |
| REQ-002 | 要件 | 既存のClaude認証情報を保持すること（コンテナ内ファイルとして） | 高 |
| REQ-003 | 要件 | MCP設定（~/.claude.json）が通常ファイルとして管理されること | 高 |
| REQ-004 | 要件 | 全ドキュメント・プランの記載内容を新方針に合わせて更新すること | 高 |
| REQ-005 | 要件 | 既存ボリューム利用者向けの移行手順を提供すること | 中 |
| CON-001 | 制約 | 既にコメントアウト済みのため、コンテナ再ビルド不要（ボリューム定義削除のみで完了可） | - |
| CON-002 | 制約 | 単一コンテナ・マルチプロジェクト環境の方針は維持 | - |
| GUD-001 | ガイドライン | Claude認証は初回のみ実施、以降はコンテナ内に保存 | - |
| GUD-002 | ガイドライン | コンテナ再作成時には再認証が必要（これは許容する） | - |

## 3. 実装ステップ

### Phase 1: 設定ファイルのクリーンアップ
**目標**: Claude永続化関連の設定を完全に削除する（ワークフロー: Express）

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-001 | docker-compose.ymlからボリューム定義を削除 | .devcontainer/docker-compose.yml | `claude-config`、`claude-json`の定義が存在しない | [ ] |
| TASK-002 | docker-compose.ymlのコメントアウト行を削除 | .devcontainer/docker-compose.yml | ボリュームマウントのコメント行が存在しない | [ ] |
| TASK-003 | 不要なコメント（post_start）を削除 | .devcontainer/docker-compose.yml | post_startのコメント行が存在しない | [ ] |

### Phase 2: 関連プラン・ドキュメントの更新
**目標**: Claude設定永続化に関する記載を全ドキュメント・プランで削除または修正する

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-010 | 251212プランの5.7節とdocker-compose.yml例を更新 | ai/plans/251212_単一コンテナ・マルチプロジェクト導入プラン.md | Claude設定永続化の記載を削除し、方針変更を明記 | [ ] |
| TASK-011 | CLAUDE.mdの記載を更新 | CLAUDE.md | Claude設定永続化に関する誤解を招く記載を削除 | [ ] |
| TASK-012 | 本プランを251212プランに関連付け | ai/plans/251212_単一コンテナ・マルチプロジェクト導入プラン.md | 変更履歴に本プラン（251213_Claude永続化設定削除プラン.md）を参照として追記 | [ ] |
| TASK-015 | docs/multi-project-setup.mdの記載を更新 | docs/multi-project-setup.md | Claude設定永続化の記載を削除し、新方針を明記 | [ ] |

### Phase 3: 既存ボリューム移行手順の追加
**目標**: 既存ボリューム利用者向けの設定退避・移行手順を提供する

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-020 | 既存ボリュームからの設定抽出手順を追加 | 本プラン（セクション9） | ボリュームデータ抽出方法が明記されている | [x] |
| TASK-021 | 抽出した設定のコンテナ内配置手順を追加 | 本プラン（セクション9） | 設定ファイル配置方法が明記されている | [x] |

### Phase 4: 検証とドキュメント化
**目標**: 変更内容の検証と運用ガイドの整備

| タスクID | 内容 | 対象ファイル | 完了条件 | 状態 |
|----------|------|-------------|---------|------|
| TASK-030 | docker compose configでYAML検証 | - | エラーなし、不要なボリューム定義なし | [ ] |
| TASK-031 | devcontainer.json参照の確認 | .devcontainer/devcontainer.json | Claude関連ボリュームへの参照がない | [ ] |
| TASK-032 | 全ドキュメント・プランの整合性確認 | 全プラン・ドキュメント | Claude永続化に関する記載が一致している | [ ] |
| TASK-033 | コンテナ再作成後の認証フロー確認 | - | コンテナ再作成後に`claude login`が正常に動作する | [ ] |
| TASK-034 | Claude認証の運用手順を文書化 | docs/multi-project-setup.md | 初回認証手順が明記されている | [ ] |

## 4. 詳細設計

### 4.1 docker-compose.yml修正内容

#### 修正前（現在）
```yaml
volumes:
  # ワークスペース全体をマウント
  - ..:/workspaces/ai-work-container:cached
  # メインプロジェクトのnode_modules
  - ai-work-container-node_modules:/workspaces/ai-work-container/node_modules
  # # Claude設定を永続化
  # - claude-config:/home/vscode/.config/claude-code
  # - claude-json:/home/vscode/.claude.json

# （中略）

volumes:
  ai-work-container-node_modules:
  claude-config:
  claude-json:
  # 追加プロジェクト用ボリュームはinit-project.shで動的に追加
```

#### 修正後
```yaml
volumes:
  # ワークスペース全体をマウント
  - ..:/workspaces/ai-work-container:cached
  # メインプロジェクトのnode_modules
  - ai-work-container-node_modules:/workspaces/ai-work-container/node_modules

# （中略）

volumes:
  ai-work-container-node_modules:
  # 追加プロジェクト用ボリュームはinit-project.shで動的に追加
```

### 4.2 251212プラン修正内容

#### セクション5.7の修正

修正前:
```markdown
### 5.7 Claude認証・MCP設定の共有
Claude Code CLIの認証情報とMCP設定は以下の場所に保存される：
- 認証: `~/.config/claude-code/`（名前付きボリューム`claude-config`で永続化）
- MCP設定: `~/.claude.json`（名前付きボリューム`claude-json`で永続化）

これらはユーザーホームディレクトリに保存されるため、同一コンテナ内のすべてのプロジェクトで自動的に共有される。
```

修正後:
```markdown
### 5.7 Claude認証・MCP設定の共有

**方針変更（2025-12-13）**: Claude設定のボリューム永続化を廃止しました。詳細は @ai/plans/251213_Claude永続化設定削除プラン.md を参照。

Claude Code CLIの認証情報とMCP設定は以下の場所に保存される：
- 認証: `~/.config/claude-code/`（コンテナ内通常ディレクトリ）
- MCP設定: `~/.claude.json`（コンテナ内通常ファイル）

これらはユーザーホームディレクトリに保存されるため、同一コンテナ内のすべてのプロジェクトで自動的に共有される。

**重要**: コンテナ再作成時には再認証が必要です。初回起動後に `claude login` を実行してください。
```

#### docker-compose.yml例の修正

セクション5.2のdocker-compose.yml例から以下の行を削除:
```yaml
# Claude設定を永続化
- claude-config:/home/vscode/.config/claude-code
- claude-json:/home/vscode/.claude.json
```

volumesセクションから以下を削除:
```yaml
claude-config:
claude-json:
```

### 4.3 CLAUDE.md修正内容

「マルチプロジェクト環境」セクションの「共通設定の利用」から以下を削除:
```markdown
- **Claude Code認証**: `~/.config/claude-code/` で全プロジェクト共有
- **MCP設定**: `~/.claude.json` で全プロジェクト共有
```

修正後:
```markdown
### 共通設定の利用
- **Claude Code認証**: コンテナ内で初回のみ認証（`claude login`）、同一コンテナ内の全プロジェクトで共有
- **MCP設定**: `~/.claude.json` で全プロジェクト共有（コンテナ内ファイル）
- **GitHub設定**: `.github/` へのシンボリックリンクで継承
- **Claude設定**: `.claude/` へのシンボリックリンクで継承

**注意**: コンテナ再作成時にはClaude Code CLIの再認証が必要です。
```

## 5. テスト計画

| テストID | 種別 | 内容 | 期待結果 |
|----------|------|------|---------|
| TEST-001 | 静的 | `docker compose config`でYAML構文検証 | エラーなし、警告なし |
| TEST-002 | 静的 | volumes定義の確認 | `claude-config`、`claude-json`が存在しない |
| TEST-003 | 静的 | devcontainer.json参照の確認 | Claude関連ボリュームへの参照がない |
| TEST-004 | 静的 | サンプルcompose断片の確認 | 251212プラン内のdocker-compose.yml例にClaude関連ボリュームがない |
| TEST-005 | 手動 | 既存コンテナでClaude動作確認 | `claude --version`が成功する |
| TEST-006 | 手動 | MCP設定の確認 | `~/.claude.json`が通常ファイルとして存在 |
| TEST-007 | 統合 | 全ドキュメント・プランの一貫性確認 | Claude永続化に関する記載が新方針と一致している |
| TEST-008 | 統合 | コンテナ再作成後の認証フロー | コンテナ再作成後に`claude login`が正常に動作し、設定が保存される |
| TEST-009 | 統合 | 既存ボリューム移行手順の検証 | ボリュームから抽出した設定がコンテナ内で正常に動作する |

## 6. 成功基準

- [ ] docker-compose.ymlに`claude-config`、`claude-json`ボリュームが存在しない
- [ ] devcontainer.jsonにClaude関連ボリュームへの参照が存在しない
- [ ] コメントアウト行が完全に削除されている
- [ ] `docker compose config`がエラーなく実行できる
- [ ] 既存のClaude認証情報が保持されている
- [ ] 全ドキュメント・プラン（251212、251213_Claude関連、CLAUDE.md、multi-project-setup.md）が新方針に更新されている
- [ ] 既存ボリューム利用者向けの移行手順が明記されている
- [ ] 運用ガイドに初回認証手順が記載されている
- [ ] コンテナ再作成後の認証フローが正常に動作する

## 7. リスクと対策

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| RISK-001 | 既存の認証情報が失われる | 低 | 低 | ボリュームマウントは既にコメントアウト済みのため影響なし。現在のファイルをそのまま利用 |
| RISK-002 | コンテナ再作成時に再認証が必要 | 低 | 高（許容） | 初回認証手順をドキュメント化し、運用フローとして確立 |
| RISK-003 | ドキュメント・プランの記載漏れ | 中 | 中 | TASK-010～012,015で全プラン・ドキュメントを更新、TEST-007で一貫性を検証 |
| RISK-004 | 既存ボリュームの削除忘れ | 低 | 低 | docker volume lsで確認し、手動削除手順を提供（セクション10） |
| RISK-005 | 既存ボリューム利用者の移行失敗 | 中 | 低 | TASK-020,021で明確な移行手順を提供、TEST-009で検証 |
| RISK-006 | devcontainer.jsonやサンプルcompose断片への残存参照 | 低 | 中 | TASK-031、TEST-003,004で確認 |

## 8. 依存関係

- 既存のdocker-compose.yml設定（既にボリュームマウントはコメントアウト済み）
- 251212_単一コンテナ・マルチプロジェクト導入プラン.md
- CLAUDE.md
- docs/multi-project-setup.md

## 9. 既存ボリューム利用者向けの移行手順（オプション）

既に`claude-config`、`claude-json`ボリュームを使用しており、保存された設定を移行したい場合は、以下の手順でボリュームからデータを抽出し、コンテナ内に配置できます。

### 9.1 既存ボリュームの確認

```bash
# ボリューム一覧の確認
docker volume ls | grep claude

# 期待される出力例:
# local     claude-config
# local     claude-json
```

### 9.2 設定データの抽出

#### claude-configボリュームからの抽出

```bash
# 抽出先ディレクトリを作成
mkdir -p /tmp/claude-backup

# claude-configボリュームの内容をtarアーカイブとして抽出
docker run --rm \
  -v claude-config:/source:ro \
  -v /tmp/claude-backup:/backup \
  ubuntu:24.04 \
  tar czf /backup/claude-config.tar.gz -C /source .

echo "claude-config extracted to /tmp/claude-backup/claude-config.tar.gz"
```

#### claude-jsonボリュームからの抽出

```bash
# claude-jsonボリュームの内容を抽出（単一ファイル）
docker run --rm \
  -v claude-json:/source:ro \
  -v /tmp/claude-backup:/backup \
  ubuntu:24.04 \
  sh -c "if [ -f /source/.claude.json ]; then cp /source/.claude.json /backup/.claude.json; else echo 'File not found'; fi"

echo "claude-json extracted to /tmp/claude-backup/.claude.json"
```

### 9.3 コンテナ内への配置

devcontainerを起動後、コンテナ内で以下のコマンドを実行します。

```bash
# ホストから抽出したファイルをコンテナ内にコピー（VS Code経由でファイルをドラッグ&ドロップ、またはdocker cpコマンド使用）

# 方法1: docker cpコマンドを使用（コンテナ外から実行）
CONTAINER_ID=$(docker ps --filter "name=ai-work-container" --format "{{.ID}}")
docker cp /tmp/claude-backup/claude-config.tar.gz $CONTAINER_ID:/tmp/
docker cp /tmp/claude-backup/.claude.json $CONTAINER_ID:/home/vscode/

# 方法2: コンテナ内で直接操作（devcontainer起動後）
# claude-config の展開
cd ~/.config
tar xzf /tmp/claude-config.tar.gz -C claude-code/

# .claude.json の配置（既に存在する場合はバックアップ）
if [ -f ~/.claude.json ]; then
  mv ~/.claude.json ~/.claude.json.bak
fi
mv /tmp/.claude.json ~/.claude.json

# 権限設定
chown -R vscode:vscode ~/.config/claude-code ~/.claude.json
chmod 600 ~/.claude.json

echo "Migration completed. Please verify with: claude --version"
```

### 9.4 移行後の確認

```bash
# Claude Code CLIの動作確認
claude --version

# MCP設定の確認
ls -la ~/.claude.json

# 設定内容の確認（機密情報に注意）
# cat ~/.claude.json
```

## 10. 既存ボリュームのクリーンアップ（オプション）

移行完了後、または既に使用していない場合は、`claude-config`、`claude-json`ボリュームを削除できます。

### クリーンアップ手順

```bash
# ボリューム一覧の確認
docker volume ls | grep claude

# 不要なボリュームの削除
docker volume rm claude-config claude-json 2>/dev/null || echo "ボリュームが存在しないか、使用中です"
```

**注意**:
- ボリュームを削除する前に、必要なデータは必ず抽出してください
- ボリュームが残っていても動作に影響はありません（マウントされていないため）

## 11. 次のアクション

1. [ ] Phase 1（TASK-001～003）: docker-compose.ymlのクリーンアップ
2. [ ] Phase 2（TASK-010～015）: 全関連プラン・ドキュメントの更新
3. [ ] Phase 3（TASK-020～021）: 既存ボリューム移行手順の追加（セクション9への記載）
4. [ ] Phase 4（TASK-030～034）: 検証と運用ガイド整備
5. [ ] テスト計画（TEST-001～009）の実施
6. [ ] 既存ボリュームからの移行（必要に応じて、セクション9参照）
7. [ ] 既存ボリュームのクリーンアップ（オプション、セクション10参照）

---
*このプランは Plan Creator エージェントによって作成されました*
*関連プラン: @ai/plans/251212_単一コンテナ・マルチプロジェクト導入プラン.md*

## レビュー反映内容（2025-12-13）

以下のレビュー指摘を反映しました：

### 1. 他プラン・ドキュメントの整合性対応（高優先度）
- **追加対象ファイル**:
  - docs/multi-project-setup.md
- **追加タスク**: TASK-015（更新）
- **影響**: Phase 2のタスク数が3→4に増加

### 2. 検証範囲の拡充（中優先度）
- **追加検証項目**:
  - devcontainer.json参照の確認（TEST-003）
  - サンプルcompose断片の確認（TEST-004）
  - コンテナ再作成後の認証フロー確認（TEST-008）
  - 既存ボリューム移行手順の検証（TEST-009）
- **追加タスク**: TASK-030～034（Phase 4に統合）
- **影響**: テスト項目が5→9に増加

### 3. 既存ボリューム移行手順の追加（中優先度）
- **新規セクション**: セクション9「既存ボリューム利用者向けの移行手順」
- **内容**:
  - ボリュームからのデータ抽出方法（docker run活用）
  - コンテナ内への配置手順
  - 移行後の確認方法
- **追加タスク**: TASK-020～021（Phase 3、本プラン作成時に完了）
- **リスク対策**: RISK-005を追加

### 4. その他の改善
- **要件追加**: REQ-005（既存ボリューム利用者向けの移行手順提供）
- **リスク追加**: RISK-006（devcontainer.jsonやサンプルcompose断片への残存参照）
- **成功基準拡充**: 全10項目に拡大（旧6項目から）
- **セクション番号調整**: 既存ボリュームのクリーンアップをセクション10に変更
